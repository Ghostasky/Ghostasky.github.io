<!DOCTYPE html>
<html lang="zh-cn" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="郁涛丶" />
  <meta name="description" content="" />
  
  
  <title>
    
      Windows内核(十一)——软件调试 
      
      
      |
    
     郁涛丶&#39;s Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  
    
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 5.4.2"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Ghostasky</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Windows内核(十一)——软件调试</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2023-03-12	  
        </span>
		
		 <span class="post-pubtime"> 本文共9.4k字 </span>

                                                                        <span class="post-pubtime">
        大约需要70min
      </span>
		
		
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="Categories"></i>
                
                <span class="span--category">
                  <a href="/categories/Technology/" title="Technology">
                    <b>#</b> Technology
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Win32/" title="Win32">
                    #Win32
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>[toc]</p>
<p>最后一部分了，接下来好好写个调试器，看看win内核的洞去了。</p>
<h1 id="01-调试对象"><a href="#01-调试对象" class="headerlink" title="01.调试对象"></a>01.调试对象</h1><h2 id="调试器与被调试程序"><a href="#调试器与被调试程序" class="headerlink" title="调试器与被调试程序"></a>调试器与被调试程序</h2><p>示例图如下：</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230308214733381.png" alt="image-20230308214733381"></p>
<p><strong>调试器与被调试对象建立联系的方式</strong>：</p>
<ol>
<li>CreateProcess（创建进程）</li>
<li><strong>DebugActiveProcess（附加进程）</strong></li>
</ol>
<p>这里主要是附加进程的方式。</p>
<h2 id="DebugActiveProcess"><a href="#DebugActiveProcess" class="headerlink" title="DebugActiveProcess"></a>DebugActiveProcess</h2><p>调试器进程执行流程：</p>
<ol>
<li><p>kernel32!DebugActiveProcess()</p>
</li>
<li><p>ntdll!DbgUiConnectToDbg()</p>
</li>
<li><p>ntdll!ZwCreateDebugObject()</p>
</li>
<li><p>nt!NtCreateDebugObject()</p>
</li>
</ol>
<p>被调试程序执行流程</p>
<ol>
<li><p>kernel32!DebugActiveProcess()</p>
</li>
<li><p>kernel32!DbgUiDebugActiveProcess(被调试进程句柄)</p>
</li>
<li><p>ntdll!DbgUiDebugActiveProcess(被调试进程句柄)</p>
</li>
<li><p>ntdll!NtDebugActiveProcess(被调试进程句柄,调试器进程TEB+0xF24)</p>
</li>
<li><p>nt!NtDebugActiveProcess(HANDLE ProcessHandle, HANDLE DebugObjectHandle)</p>
</li>
<li><p>nt!DbgkpSetProcessDebugObject：把调试对象和被调试进程关联起来</p>
</li>
</ol>
<p>大致流程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kernel32!DebugActiveProcess:</span><br><span class="line">	<span class="number">1.</span>创建调试对象：ntdll!DbgUiConnectToDbg()</span><br><span class="line">        <span class="number">1.</span>ntdll!ZwCreateDebugObject()，放到TEB+F24的位置</span><br><span class="line">    <span class="number">2.</span>获取被调试进程的句柄</span><br><span class="line">    <span class="number">3.</span>通过句柄激活被调试进程：ntdll!DbgUiDebugActiveProcess</span><br><span class="line">        <span class="number">1.</span>Nt!NtDebugActiveProcess：传入被调试进程句柄与调试对象</span><br><span class="line">        	<span class="number">1.</span>获取被调试进程的EPROCESS结构体</span><br><span class="line">        	<span class="number">2.</span>获取调试对象的结构体，放到Process（变量复用</span><br><span class="line">        	<span class="number">3.</span>调用nt!DbgkpSetProcessDebugObject将调试与被调试进程连接起来</span><br><span class="line">        		<span class="number">1.</span>将被调试进程的DebugPort传入Debug_Object</span><br></pre></td></tr></table></figure>







<h3 id="kernel32-DebugActiveProcess"><a href="#kernel32-DebugActiveProcess" class="headerlink" title="kernel32!DebugActiveProcess"></a>kernel32!DebugActiveProcess</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.text:7C85B0FB ; BOOL __stdcall DebugActiveProcess(DWORD dwProcessId)</span><br><span class="line">.text:7C85B0FB                 public _DebugActiveProcess@4</span><br><span class="line">.text:7C85B0FB _DebugActiveProcess@4 proc near         ; DATA XREF: .text:off_7C802654↑o</span><br><span class="line">.text:7C85B0FB</span><br><span class="line">.text:7C85B0FB dwProcessId     = dword ptr  8</span><br><span class="line">.text:7C85B0FB</span><br><span class="line">.text:7C85B0FB                 mov     edi, edi</span><br><span class="line">.text:7C85B0FD                 push    ebp</span><br><span class="line">.text:7C85B0FE                 mov     ebp, esp</span><br><span class="line">.text:7C85B100                 call    _DbgUiConnectToDbg@0 ; 创建调试对象，跟入</span><br><span class="line">.text:7C85B105                 test    eax, eax</span><br><span class="line">.text:7C85B107                 jge     short loc_7C85B113;1.成功创建调试对象，跳转</span><br><span class="line">.text:7C85B109                 push    eax             ; Status</span><br><span class="line">.text:7C85B10A                 call    _BaseSetLastNTError@4  </span><br><span class="line">.text:7C85B10F                 xor     eax, eax</span><br><span class="line">.text:7C85B111                 jmp     short loc_7C85B145</span><br></pre></td></tr></table></figure>

<p>跟入<code>ntdll!DbgUiConnectToDbg</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">.text:7C96FEF1                 public _DbgUiConnectToDbg@0</span><br><span class="line">.text:7C96FEF1 _DbgUiConnectToDbg@0 proc near          ; DATA XREF: .text:off_7C923428↑o</span><br><span class="line">.text:7C96FEF1</span><br><span class="line">.text:7C96FEF1 var_18          = dword ptr -18h</span><br><span class="line">.text:7C96FEF1 var_14          = dword ptr -14h</span><br><span class="line">.text:7C96FEF1 var_10          = dword ptr -10h</span><br><span class="line">.text:7C96FEF1 var_C           = dword ptr -0Ch</span><br><span class="line">.text:7C96FEF1 var_8           = dword ptr -8</span><br><span class="line">.text:7C96FEF1 var_4           = dword ptr -4</span><br><span class="line">.text:7C96FEF1</span><br><span class="line">.text:7C96FEF1                 mov     edi, edi</span><br><span class="line">.text:7C96FEF3                 push    ebp</span><br><span class="line">.text:7C96FEF4                 mov     ebp, esp</span><br><span class="line">.text:7C96FEF6                 sub     esp, 18h</span><br><span class="line">.text:7C96FEF9                 xor     ecx, ecx</span><br><span class="line">.text:7C96FEFB                 mov     eax, large fs:TEB.NtTib.Self</span><br><span class="line">.text:7C96FF01                 cmp     [eax+0F24h], ecx</span><br><span class="line">.text:7C96FF07                 jnz     short loc_7C96FF3D</span><br><span class="line">.text:7C96FF09                 mov     [ebp+var_18], 18h</span><br><span class="line">.text:7C96FF10                 mov     [ebp+var_14], ecx</span><br><span class="line">.text:7C96FF13                 mov     [ebp+var_C], ecx</span><br><span class="line">.text:7C96FF16                 mov     [ebp+var_10], ecx</span><br><span class="line">.text:7C96FF19                 mov     [ebp+var_8], ecx</span><br><span class="line">.text:7C96FF1C                 mov     [ebp+var_4], ecx</span><br><span class="line">.text:7C96FF1F                 mov     eax, large fs:18h</span><br><span class="line">.text:7C96FF25                 push    1</span><br><span class="line">.text:7C96FF27                 lea     ecx, [ebp+var_18]</span><br><span class="line">.text:7C96FF2A                 push    ecx</span><br><span class="line">.text:7C96FF2B                 push    1F000Fh</span><br><span class="line">.text:7C96FF30                 add     eax, 0F24h      ; TEB+F24</span><br><span class="line">.text:7C96FF35                 push    eax             ; 入栈，用于存放创建出来的句柄</span><br><span class="line">.text:7C96FF36                 call    _ZwCreateDebugObject@16 ; ZwCreateDebugObject(x,x,x,x)</span><br><span class="line">.text:7C96FF3B                 mov     ecx, eax</span><br></pre></td></tr></table></figure>

<p><code>ZwCreateDebugObject</code> 第一个参数是OUT类型返回一个句柄，返回到EAX了，这时EAX的位置是<code>TEB+0xF24</code>的位置。</p>
<p><strong>CreateDebugObject</strong>的目的是创建一个<strong>DebugObject</strong>对象，并存放在TEB(0xF24)。</p>
<p>之后继续是<code>kernel32!DebugActiveProcess</code>的<code>loc_7C85B113</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:7C85B113 loc_7C85B113:                           ; CODE XREF: DebugActiveProcess(x)+C↑j</span><br><span class="line">.text:7C85B113                 push    esi</span><br><span class="line">.text:7C85B114                 push    [ebp+dwProcessId] ; ProcessHandle</span><br><span class="line">.text:7C85B117                 call    _ProcessIdToHandle@4 ; 2.根据进程ID获取被调试进程的句柄</span><br><span class="line">.text:7C85B11C                 mov     esi, eax</span><br><span class="line">.text:7C85B11E                 test    esi, esi</span><br><span class="line">.text:7C85B120                 jz      short loc_7C85B144</span><br><span class="line">.text:7C85B122                 push    edi</span><br><span class="line">.text:7C85B123                 push    esi             ; 3.被调试郡城的句柄</span><br><span class="line">.text:7C85B124                 call    _DbgUiDebugActiveProcess@4 ; 跟入</span><br></pre></td></tr></table></figure>

<p><code>ntdll!DbgUiDebugActiveProcess</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.text:7C970082 _DbgUiDebugActiveProcess@4 proc near    ; DATA XREF: .text:off_7C923428↑o</span><br><span class="line">.text:7C970082</span><br><span class="line">.text:7C970082 Handle          = dword ptr  8</span><br><span class="line">.text:7C970082</span><br><span class="line">.text:7C970082                 mov     edi, edi</span><br><span class="line">.text:7C970084                 push    ebp</span><br><span class="line">.text:7C970085                 mov     ebp, esp</span><br><span class="line">.text:7C970087                 push    esi</span><br><span class="line">.text:7C970088                 mov     eax, large fs:TEB.NtTib.Self</span><br><span class="line">.text:7C97008E                 push    dword ptr [eax+0F24h] ; 调试器线程：TEB+F24，挑食对象(_DEBGU_OBJECT)</span><br><span class="line">.text:7C970094                 push    [ebp+Handle]    ; 被调试进程的句柄</span><br><span class="line">.text:7C970097                 call    _NtDebugActiveProcess@8 ; 跟入</span><br></pre></td></tr></table></figure>

<p>这里开始进入0环</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:7C92D1D0 _NtDebugActiveProcess@8 proc near       ; CODE XREF: DbgUiDebugActiveProcess(x)+15↓p</span><br><span class="line">.text:7C92D1D0                                         ; DATA XREF: .text:off_7C923428↑o</span><br><span class="line">.text:7C92D1D0                 mov     eax, 39h ; &#x27;9&#x27;  ; NtDebugActiveProcess</span><br><span class="line">.text:7C92D1D5                 mov     edx, 7FFE0300h</span><br><span class="line">.text:7C92D1DA                 call    dword ptr [edx]</span><br><span class="line">.text:7C92D1DC                 retn    8</span><br><span class="line">.text:7C92D1DC _NtDebugActiveProcess@8 endp</span><br></pre></td></tr></table></figure>

<p><strong>NtDebugActiveProcess</strong>的实现位于<strong>nt!NtDebugActiveProcess</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">PAGE:0058C431 ; NTSTATUS __stdcall NtDebugActiveProcess(HANDLE Process, HANDLE DebugObject)</span><br><span class="line">PAGE:0058C431 _NtDebugActiveProcess@8 proc near       ; DATA XREF: .text:0040D904↑o</span><br><span class="line">PAGE:0058C431</span><br><span class="line">PAGE:0058C431 AccessMode      = byte ptr -4</span><br><span class="line">PAGE:0058C431 Process         = dword ptr  8</span><br><span class="line">PAGE:0058C431 DebugObject     = dword ptr  0Ch</span><br><span class="line">PAGE:0058C431</span><br><span class="line">PAGE:0058C431                 mov     edi, edi</span><br><span class="line">PAGE:0058C433                 push    ebp</span><br><span class="line">PAGE:0058C434                 mov     ebp, esp</span><br><span class="line">PAGE:0058C436                 push    ecx</span><br><span class="line">PAGE:0058C437                 mov     eax, large fs:KPCR.PrcbData.CurrentThread</span><br><span class="line">PAGE:0058C43D                 mov     al, [eax+140h]</span><br><span class="line">PAGE:0058C443                 push    0               ; HandleInformation</span><br><span class="line">PAGE:0058C445                 mov     [ebp+AccessMode], al</span><br><span class="line">PAGE:0058C448                 lea     eax, [ebp+Process]</span><br><span class="line">PAGE:0058C44B                 push    eax             ; Object</span><br><span class="line">PAGE:0058C44B                                         ; OUT PEPROCESS</span><br><span class="line">PAGE:0058C44C                 push    dword ptr [ebp+AccessMode] ; AccessMode</span><br><span class="line">PAGE:0058C44F                 push    _PsProcessType  ; ObjectType</span><br><span class="line">PAGE:0058C455                 push    800h            ; DesiredAccess</span><br><span class="line">PAGE:0058C45A                 push    [ebp+Process]   ; Handle</span><br><span class="line">PAGE:0058C45A                                         ; 被调试进程的句柄</span><br><span class="line">PAGE:0058C45D                 call    _ObReferenceObjectByHandle@24 ; 得到被调试进程的KPROCESS</span><br><span class="line">PAGE:0058C462                 test    eax, eax        ; 如果KPROCESS返回为空，无效，返回</span><br><span class="line">PAGE:0058C464                 jl      locret_58C4F8</span><br><span class="line">PAGE:0058C46A                 push    ebx</span><br><span class="line">PAGE:0058C46B                 push    esi</span><br><span class="line">PAGE:0058C46C                 mov     eax, large fs:KPCR.PrcbData.CurrentThread ; eax：当前线程</span><br><span class="line">PAGE:0058C472                 mov     esi, [ebp+Process] ; esi：被调试进程</span><br><span class="line">PAGE:0058C475                 cmp     esi, [eax+_KTHREAD.ApcState.Process] ; 取当前线程的所属进程</span><br><span class="line">PAGE:0058C478                 jz      short loc_58C4E8 ; 被调试进程是当前线程，结束</span><br><span class="line">PAGE:0058C47A                 cmp     esi, _PsInitialSystemProcess ; 被调试进程是系统初始化进程，结束</span><br><span class="line">PAGE:0058C480                 jz      short loc_58C4E8</span><br><span class="line">PAGE:0058C482                 push    0               ; HandleInformation</span><br><span class="line">PAGE:0058C484                 lea     eax, [ebp+Process]</span><br><span class="line">PAGE:0058C487                 push    eax             ; Object</span><br><span class="line">PAGE:0058C488                 push    dword ptr [ebp+AccessMode] ; AccessMode</span><br><span class="line">PAGE:0058C48B                 push    _DbgkDebugObjectType ; ObjectType</span><br><span class="line">PAGE:0058C491                 push    2               ; DesiredAccess</span><br><span class="line">PAGE:0058C493                 push    [ebp+DebugObject] ; Handle</span><br><span class="line">PAGE:0058C496                 call    _ObReferenceObjectByHandle@24 ; 获取调试对象的地址</span><br><span class="line">PAGE:0058C49B                 mov     ebx, eax</span><br><span class="line">PAGE:0058C49D                 test    ebx, ebx</span><br><span class="line">PAGE:0058C49F                 jl      short loc_58C4ED</span><br><span class="line">PAGE:0058C4A1                 push    edi</span><br><span class="line">PAGE:0058C4A2                 lea     edi, [esi+80h]</span><br><span class="line">PAGE:0058C4A8                 mov     ecx, edi        ; RunRef</span><br><span class="line">PAGE:0058C4AA                 call    @ExAcquireRundownProtection@4 ; 锁住共享对象避免在访问的时候被删除</span><br><span class="line">PAGE:0058C4AF                 test    al, al</span><br><span class="line">PAGE:0058C4B1                 jz      short loc_58C4D8</span><br><span class="line">PAGE:0058C4B3                 lea     eax, [ebp+DebugObject]</span><br><span class="line">PAGE:0058C4B6                 push    eax             ; int</span><br><span class="line">PAGE:0058C4B7                 push    [ebp+Process]   ; FastMutex</span><br><span class="line">PAGE:0058C4BA                 push    esi             ; PROCESS</span><br><span class="line">PAGE:0058C4BB                 call    _DbgkpPostFakeProcessCreateMessages@12 ; 发送一个假的进程创建消息</span><br><span class="line">PAGE:0058C4C0                 push    [ebp+DebugObject] ; Object，调试对象的地址</span><br><span class="line">PAGE:0058C4C3                 push    eax             ; int</span><br><span class="line">PAGE:0058C4C4                 push    [ebp+Process]   ; PVOID，调试对象的地址</span><br><span class="line">PAGE:0058C4C7                 push    esi             ; PVOID，被调试进程</span><br><span class="line">PAGE:0058C4C8                 call    _DbgkpSetProcessDebugObject@16 ; 将调试进程和被调试进程关联起来（关联DebugPort）</span><br><span class="line">PAGE:0058C4CD                 mov     ecx, edi        ; RunRef</span><br><span class="line">PAGE:0058C4CF                 mov     ebx, eax</span><br><span class="line">PAGE:0058C4D1                 call    @ExReleaseRundownProtection@4 ; 是否为对象锁</span><br><span class="line">PAGE:0058C4D6                 jmp     short loc_58C4DD</span><br></pre></td></tr></table></figure>

<p>跟入<code>_DbgkpSetProcessDebugObject</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PAGE:0058C234 loc_58C234:                             ; CODE XREF: DbgkpSetProcessDebugObject(x,x,x,x)+34↑j</span><br><span class="line">PAGE:0058C234                 cmp     [ebp+arg_8], ebx</span><br><span class="line">PAGE:0058C237                 mov     edi, [ebp+arg_0]</span><br><span class="line">PAGE:0058C23A                 mov     esi, ds:__imp_@ExAcquireFastMutex@4 ; ExAcquireFastMutex(x)</span><br><span class="line">PAGE:0058C240                 jl      loc_58C2D9</span><br><span class="line">PAGE:0058C246                 mov     ecx, offset _DbgkpProcessDebugPortMutex ; FastMutex</span><br><span class="line">PAGE:0058C24B                 mov     [ebp+var_1], 1</span><br><span class="line">PAGE:0058C24F                 call    esi ; ExAcquireFastMutex(x) ; ExAcquireFastMutex(x)</span><br><span class="line">PAGE:0058C251                 cmp     [edi+_EPROCESS.DebugPort], ebx ; 判断DebugPort是否为0</span><br><span class="line">PAGE:0058C257                 jnz     short loc_58C2CC</span><br><span class="line">PAGE:0058C259</span><br><span class="line">PAGE:0058C259 loc_58C259:                             ; CODE XREF: DbgkpSetProcessDebugObject(x,x,x,x)+CF↓j</span><br><span class="line">PAGE:0058C259                 mov     eax, [ebp+arg_4]</span><br><span class="line">PAGE:0058C25C                 mov     ecx, [ebp+Object] ; Object</span><br><span class="line">PAGE:0058C25F                 mov     [edi+_EPROCESS.DebugPort], eax ; 将调试进程的句柄放到被调试进程的EPROCESS的DebugPort</span><br><span class="line">PAGE:0058C265                 call    @ObfReferenceObject@4 ; ObfReferenceObject(x)</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230309191507860.png" alt="image-20230309191507860"></p>
<h1 id="02-调试事件的采集"><a href="#02-调试事件的采集" class="headerlink" title="02.调试事件的采集"></a>02.调试事件的采集</h1><ol>
<li>调试器与被调试进程通过<strong>DEBUG_OBJECT</strong>结构体建立联系。</li>
<li><code>DEBUG_OBJECT</code>中有一个链表成员，用于记录所有<strong>调试事件</strong>。</li>
<li>当被调试进程产生调试事件时，调试器从链表中取出调试事件进行处理。</li>
</ol>
<p>结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_OBJECT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    KEVENT EventsPresent;<span class="comment">//+00用于指示有调试事件发生</span></span><br><span class="line">    FAST_MUTEX Mutex;<span class="comment">//+10用于同步互斥体</span></span><br><span class="line">    LIST_ENTRY EventList;<span class="comment">//+30保存调试消息的链表</span></span><br><span class="line">   </span><br><span class="line">    <span class="class"><span class="keyword">union</span>//标志 调试消息是否以读取</span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG Flags;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            UCHAR DebuggerInactive:<span class="number">1</span>;</span><br><span class="line">            UCHAR KillProcessOnExit:<span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; DEBUG_OBJECT, *PDEBUG_OBJECT;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>EventList是一个链表，每一个节点都是一个调试事件，当“被调试进程”产生调试事件会存到EventList的节点中。</p>
</li>
<li><p>调试器就是从EventList的节点里取出调试事件来进行处理。</p>
</li>
<li><p>调试事件是有种类的，被调试进程只有调试事件才会被写入EventList的节点中，那些打印了某某字符，申请一块内存是不会记录的。</p>
</li>
</ol>
<h2 id="调试事件的种类"><a href="#调试事件的种类" class="headerlink" title="调试事件的种类"></a>调试事件的种类</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DBGKM_APINUMBER</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">DbgkmExceptionApi = <span class="number">0</span>, <span class="comment">// 异常</span></span><br><span class="line">DbgkmCreateThreadApi = <span class="number">1</span>, <span class="comment">// 创建线程</span></span><br><span class="line">DbgkmCreateProcessApi = <span class="number">2</span>, <span class="comment">// 创建进程</span></span><br><span class="line">DbgkmExitThreadApi = <span class="number">3</span>, <span class="comment">// 退出线程</span></span><br><span class="line">DbgkmExitProcessApi = <span class="number">4</span>, <span class="comment">// 进程退出</span></span><br><span class="line">DbgkmLoadDllApi = <span class="number">5</span>, <span class="comment">// 加载DLL</span></span><br><span class="line">DbgkmUnloadDllApi = <span class="number">6</span>, <span class="comment">// 卸载DLL</span></span><br><span class="line">DbgkmErrorReportApi = <span class="number">7</span>, <span class="comment">//内部错误（已经不用了）</span></span><br><span class="line">DbgkmMaxApiNumber = <span class="number">8</span>, <span class="comment">// 这组常量的最大值</span></span><br><span class="line">&#125; DBGKM_APINUMBER;</span><br></pre></td></tr></table></figure>



<h2 id="调试事件采集函数"><a href="#调试事件采集函数" class="headerlink" title="调试事件采集函数"></a>调试事件采集函数</h2><p>触发异常等时，用来生成调试事件。</p>
<p>&lt;1&gt; 创建进程、线程必经之路:<br>    <code>PspUserThreadStartup</code><br>        <code>DbgkCreateThread</code><br>            <code>DbgkpSendApiMessage(x, x)</code><br>&lt;2&gt; 退出线程、进程必经之路：<br>    <code>PspExitThread</code><br>        <code>DbgkExitThread</code>/<code>DbgkExitProcess</code><br>            <code>DbgkpSendApiMessage(x, x)</code><br>&lt;3&gt; 加载模块的必经之路：<br>    <code>NtMapViewOfSection</code><br>        <code>DbgkMapViewOfSection</code><br>            <code>DbgkpSendApiMessage(x, x)</code><br>&lt;4&gt; 卸载模块的必经之路：<br>    <code>NtUnMapViewOfSection</code><br>        <code>DbgkUnMapViewOfSection</code><br>            <code>DbgkpSendApiMessage(x, x)</code><br>&lt;5&gt; 异常的必经之路：<br>    <code>KiDispatchException</code><br>        <code>DbgkForwardException</code><br>            <code>DbgkpSendApiMessage(x, x)</code></p>
<p>上述的所有第二个以Dbgk开头的都是调试事件的采集函数。</p>
<h3 id="PspUserThreadStartup"><a href="#PspUserThreadStartup" class="headerlink" title="PspUserThreadStartup"></a>PspUserThreadStartup</h3><p>创建线程，事件采集必须要知道这些事件，如果不知道就生成不了调试事件，系统已经在你的创建线程必经之路上加了一个调用，只要你创建线程就会被收集到事件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PAGE:004ADF4B loc_4ADF4B:                             ; CODE XREF: PspUserThreadStartup(x,x)+44↑j</span><br><span class="line">PAGE:004ADF4B                 xor     cl, cl          ; NewIrql</span><br><span class="line">PAGE:004ADF4D                 call    ds:__imp_@KfLowerIrql@4 ; KfLowerIrql(x)</span><br><span class="line">PAGE:004ADF53                 test    byte ptr [esi+248h], 6</span><br><span class="line">PAGE:004ADF5A                 jnz     short loc_4ADF64</span><br><span class="line">PAGE:004ADF5C                 push    [ebp+arg_4]</span><br><span class="line">PAGE:004ADF5F                 call    _DbgkCreateThread@4 ; 判断当前线程是否为当前进程的第一个线程</span><br><span class="line">PAGE:004ADF5F                                         ; 是：生成调试事件，编号为2(创建进程)</span><br><span class="line">PAGE:004ADF5F                                         ; 否：生成调试事件，编号为1(创建线程)</span><br><span class="line">PAGE:004ADF64</span><br></pre></td></tr></table></figure>

<p>如果你是这个进程中的第一条线程（main线程），它会生成一个调试事件类型是 DbgkmCreateProcessApi = 2 // 创建进程 ，如果它发现你不是这个进程的第一个线程它也会生成一个调试事件类型是 DbgkmCreateThreadApi = 1 // 创建线程 。</p>
<h3 id="PspExitThread"><a href="#PspExitThread" class="headerlink" title="PspExitThread"></a>PspExitThread</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">PAGE:0049E9A6 loc_49E9A6:                             ; CODE XREF: PspExitThread(x)+1A8A9↓j</span><br><span class="line">PAGE:0049E9A6                 cmp     [edi+_EPROCESS.DebugPort], 0 ; 判断DebugPort是否为0，</span><br><span class="line">PAGE:0049E9A6                                         ; 为0，表示未处于调试状态，不产生调试信息</span><br><span class="line">PAGE:0049E9AD                 jnz     loc_52E3D6      ; 不为0，跳转PAGE:0052E3D6 loc_52E3D6:                             ; CODE XREF: PspExitThread(x)+EF↑j</span><br><span class="line">PAGE:0052E3D6                 test    byte ptr [esi+248h], 10h</span><br><span class="line">PAGE:0052E3DD                 jnz     loc_49E9B3</span><br><span class="line">PAGE:0052E3E3                 cmp     [ebp+var_19], 0</span><br><span class="line">PAGE:0052E3E7                 jz      short loc_52E3F9</span><br><span class="line">PAGE:0052E3E9                 push    [edi+_EPROCESS.ExitStatus]</span><br><span class="line">PAGE:0052E3EF                 call    _DbgkExitProcess@4 ; 如果当前线程是当前进程的最后一个线程，退出进程</span><br><span class="line">PAGE:0052E3F4                 jmp     loc_49E9B3</span><br><span class="line">PAGE:0052E3F9 ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:0052E3F9</span><br><span class="line">PAGE:0052E3F9 loc_52E3F9:                             ; CODE XREF: PspExitThread(x)+8FB29↑j</span><br><span class="line">PAGE:0052E3F9                 push    [ebp+arg_0]</span><br><span class="line">PAGE:0052E3FC                 call    _DbgkExitThread@4 ; 如果当前线程不是当前进程的最后一个线程，退出线程</span><br><span class="line">PAGE:0052E401                 jmp     loc_49E9B3</span><br><span class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><br><span class="line">PAGE:0052E3D6 loc_52E3D6:                             ; CODE XREF: PspExitThread(x)+EF↑j</span><br><span class="line">PAGE:0052E3D6                 test    byte ptr [esi+248h], 10h</span><br><span class="line">PAGE:0052E3DD                 jnz     loc_49E9B3</span><br><span class="line">PAGE:0052E3E3                 cmp     [ebp+var_19], 0</span><br><span class="line">PAGE:0052E3E7                 jz      short loc_52E3F9</span><br><span class="line">PAGE:0052E3E9                 push    [edi+_EPROCESS.ExitStatus]</span><br><span class="line">PAGE:0052E3EF                 call    _DbgkExitProcess@4 ; 如果当前线程是当前进程的最后一个线程，退出进程</span><br><span class="line">PAGE:0052E3F4                 jmp     loc_49E9B3</span><br><span class="line">PAGE:0052E3F9 ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:0052E3F9</span><br><span class="line">PAGE:0052E3F9 loc_52E3F9:                             ; CODE XREF: PspExitThread(x)+8FB29↑j</span><br><span class="line">PAGE:0052E3F9                 push    [ebp+arg_0]</span><br><span class="line">PAGE:0052E3FC                 call    _DbgkExitThread@4 ; 如果当前线程不是当前进程的最后一个线程，退出线程</span><br><span class="line">PAGE:0052E401                 jmp     loc_49E9B3</span><br><span class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><br><span class="line">PAGE:0058C90B _DbgkExitProcess@4 proc near            ; CODE XREF: PspExitThread(x)+8FB31↑p</span><br><span class="line">PAGE:0058C90B</span><br><span class="line">PAGE:0058C90B var_78          = dword ptr -78h</span><br><span class="line">PAGE:0058C90B var_74          = dword ptr -74h</span><br><span class="line">PAGE:0058C90B var_60          = dword ptr -60h</span><br><span class="line">PAGE:0058C90B var_58          = dword ptr -58h</span><br><span class="line">PAGE:0058C90B arg_0           = dword ptr  8</span><br><span class="line">PAGE:0058C90B</span><br><span class="line">PAGE:0058C90B                 mov     edi, edi</span><br><span class="line">PAGE:0058C90D                 push    ebp</span><br><span class="line">PAGE:0058C90E                 mov     ebp, esp</span><br><span class="line">PAGE:0058C910                 sub     esp, 78h</span><br><span class="line">PAGE:0058C913                 mov     eax, large fs:124h</span><br><span class="line">PAGE:0058C919                 mov     ecx, [eax+44h]</span><br><span class="line">PAGE:0058C91C                 mov     eax, large fs:124h</span><br><span class="line">PAGE:0058C922                 test    byte ptr [eax+248h], 4</span><br><span class="line">PAGE:0058C929                 jnz     short locret_58C97C</span><br><span class="line">PAGE:0058C92B                 mov     ecx, [ecx+0BCh]</span><br><span class="line">PAGE:0058C931                 test    ecx, ecx</span><br><span class="line">PAGE:0058C933                 jz      short locret_58C97C</span><br><span class="line">PAGE:0058C935                 mov     eax, large fs:124h</span><br><span class="line">PAGE:0058C93B                 test    byte ptr [eax+248h], 2</span><br><span class="line">PAGE:0058C942                 jnz     short locret_58C97C</span><br><span class="line">PAGE:0058C944                 mov     eax, large fs:124h</span><br><span class="line">PAGE:0058C94A                 mov     eax, [eax+44h]</span><br><span class="line">PAGE:0058C94D                 add     eax, 78h ; &#x27;x&#x27;</span><br><span class="line">PAGE:0058C950                 push    eax             ; CurrentTime</span><br><span class="line">PAGE:0058C951                 call    _KeQuerySystemTime@4 ; KeQuerySystemTime(x)</span><br><span class="line">PAGE:0058C956                 mov     eax, [ebp+arg_0]</span><br><span class="line">PAGE:0058C959                 mov     [ebp+var_58], eax</span><br><span class="line">PAGE:0058C95C                 push    0</span><br><span class="line">PAGE:0058C95E                 lea     eax, [ebp+var_78]</span><br><span class="line">PAGE:0058C961                 push    eax</span><br><span class="line">PAGE:0058C962                 mov     [ebp+var_78], 78000Ch</span><br><span class="line">PAGE:0058C969                 mov     [ebp+var_74], 8</span><br><span class="line">PAGE:0058C970                 mov     [ebp+var_60], 4</span><br><span class="line">PAGE:0058C977                 call    _DbgkpSendApiMessage@8 ; 负责将调试信息挂入链表</span><br></pre></td></tr></table></figure>

<p>继续跟<code>_DbgkpSendApiMessage</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">PAGE:0058C6FA loc_58C6FA:                             ; CODE XREF: DbgkpSendApiMessage(x,x)+C↑j</span><br><span class="line">PAGE:0058C6FA                 mov     edx, [ebp+arg_0]</span><br><span class="line">PAGE:0058C6FD                 mov     dword ptr [edx+1Ch], 103h</span><br><span class="line">PAGE:0058C704                 mov     eax, large fs:124h</span><br><span class="line">PAGE:0058C70A                 mov     ecx, [eax+44h]</span><br><span class="line">PAGE:0058C70D                 xor     eax, eax</span><br><span class="line">PAGE:0058C70F                 inc     eax</span><br><span class="line">PAGE:0058C710                 lea     esi, [ecx+248h]</span><br><span class="line">PAGE:0058C716                 lock or [esi], eax</span><br><span class="line">PAGE:0058C719                 mov     eax, large fs:124h</span><br><span class="line">PAGE:0058C71F                 push    ebx             ; FastMutex</span><br><span class="line">PAGE:0058C720                 push    ebx             ; Event</span><br><span class="line">PAGE:0058C721                 push    edx             ; int</span><br><span class="line">PAGE:0058C722                 push    eax             ; PVOID</span><br><span class="line">PAGE:0058C723                 push    ecx             ; Object</span><br><span class="line">PAGE:0058C724                 call    _DbgkpQueueMessage@20 ; 收集调试事件的相关信息</span><br><span class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><br><span class="line">PAGE:0058B49E loc_58B49E:                             ; CODE XREF: DbgkpQueueMessage(x,x,x,x,x)+17↑j</span><br><span class="line">PAGE:0058B49E                 mov     ecx, offset _DbgkpProcessDebugPortMutex ; FastMutex</span><br><span class="line">PAGE:0058B4A3                 lea     ebx, [ebp+var_B8]</span><br><span class="line">PAGE:0058B4A9                 mov     [ebp+var_8C], esi</span><br><span class="line">PAGE:0058B4AF                 call    ds:__imp_@ExAcquireFastMutex@4 ; ExAcquireFastMutex(x)</span><br><span class="line">PAGE:0058B4B5                 mov     eax, [ebp+Object]</span><br><span class="line">PAGE:0058B4B8                 mov     eax, [eax+_EPROCESS.DebugPort] ; 从被调试程序的DebugPort得到调试对象的结构体(_DEBUG_OBJECT)</span><br><span class="line">PAGE:0058B4BE                 mov     [ebp+Event], eax</span><br><span class="line">PAGE:0058B4C1                 mov     eax, [ebp+arg_8]</span><br><span class="line">PAGE:0058B4C4                 mov     eax, [eax+_EPROCESS.Pcb.DirectoryTableBase]</span><br><span class="line">PAGE:0058B4C7                 cmp     eax, 1</span><br><span class="line">PAGE:0058B4CA                 jz      short loc_58B4D1</span><br><span class="line">PAGE:0058B4CC                 cmp     eax, 2</span><br><span class="line">PAGE:0058B4CF                 jnz     short loc_58B4E1</span><br><span class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><br><span class="line">PAGE:0058B550 loc_58B550:                             ; CODE XREF: DbgkpQueueMessage(x,x,x,x,x)+108↑j</span><br><span class="line">PAGE:0058B550                 add     ecx, 10h        ; FastMutex</span><br><span class="line">PAGE:0058B553                 mov     [ebp+FastMutex], ecx</span><br><span class="line">PAGE:0058B556                 call    ds:__imp_@ExAcquireFastMutex@4 ; ExAcquireFastMutex(x)</span><br><span class="line">PAGE:0058B55C                 mov     edx, [ebp+Event]</span><br><span class="line">PAGE:0058B55F                 test    byte ptr [edx+38h], 1</span><br><span class="line">PAGE:0058B563                 jnz     short loc_58B587</span><br><span class="line">PAGE:0058B565                 cmp     [ebp+var_4], edi</span><br><span class="line">PAGE:0058B568                 lea     eax, [edx+_DEBUG_OBJECT.EventList] ; 链表操作，添加调试事件信息</span><br><span class="line">PAGE:0058B56B                 mov     ecx, [eax+4]</span><br><span class="line">PAGE:0058B56E                 mov     [ebx], eax</span><br><span class="line">PAGE:0058B570                 mov     [ebx+4], ecx</span><br><span class="line">PAGE:0058B573                 mov     [ecx], ebx</span><br><span class="line">PAGE:0058B575                 mov     [eax+4], ebx</span><br><span class="line">PAGE:0058B578                 jnz     short loc_58B582</span><br><span class="line">PAGE:0058B57A                 push    edi             ; Wait</span><br><span class="line">PAGE:0058B57B                 push    edi             ; Increment</span><br><span class="line">PAGE:0058B57C                 push    edx             ; Event</span><br><span class="line">PAGE:0058B57D                 call    _KeSetEvent@12  ; KeSetEvent(x,x,x)</span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>调试事件有多种，真正需要关注的只有<strong>7种</strong>。</li>
<li>Windows通过在被调试进程的<strong>必经之路</strong>上调用调试事件采集函数，向<strong>DEBUG_PORT</strong>中挂入调试事件。</li>
<li>不同事件的必经之路所使用的调试事件采集函数不同，但最终都通过<strong>DbgkSendApiMessage</strong>向链表中写入调试事件信息。</li>
</ol>
<h1 id="03-调试事件的处理"><a href="#03-调试事件的处理" class="headerlink" title="03.调试事件的处理"></a>03.调试事件的处理</h1><p>调试器调试目标进程的步骤：</p>
<ol>
<li>关联(创建进程/附加进程)</li>
<li>调试循环</li>
</ol>
<h2 id="简易调试器"><a href="#简易调试器" class="headerlink" title="简易调试器"></a>简易调试器</h2><p>示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUGGEE <span class="string">&quot;C:\\NOTEPAD.EXE&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL nIsContinue = TRUE;</span><br><span class="line">	DEBUG_EVENT debugEvent = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1.创建调试进程</span></span><br><span class="line">	STARTUPINFO startupInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	PROCESS_INFORMATION pInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	GetStartupInfo(&amp;startupInfo);</span><br><span class="line"></span><br><span class="line">	bRet = CreateProcess(DEBUGGEE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, DEBUG_PROCESS || DEBUG_ONLY_THIS_PROCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;startupInfo, &amp;pInfo);</span><br><span class="line">	<span class="keyword">if</span>(!bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateProcess error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2.调试循环</span></span><br><span class="line">	<span class="keyword">while</span>(nIsContinue)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForDebugEvent(&amp;debugEvent, INFINITE);</span><br><span class="line">		<span class="keyword">if</span>(!bRet)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;WaitForDebugEvent error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span>(debugEvent.dwDebugEventCode)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="comment">//1.异常</span></span><br><span class="line">		<span class="keyword">case</span> EXCEPTION_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;EXCEPTION_DEBUG_EVENT %x %x %x \n&quot;</span>,</span><br><span class="line">				debugEvent.u.Exception.ExceptionRecord.ExceptionAddress,</span><br><span class="line">				debugEvent.u.Exception.ExceptionRecord.ExceptionCode,</span><br><span class="line">				debugEvent.u.Exception.ExceptionRecord.ExceptionFlags);</span><br><span class="line">			<span class="comment">//printf(&quot;EXCEPTION_DEBUG_EVENT\n&quot;);</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//2.</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;CREATE_THREAD_DEBUG_EVENT \n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//3.</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;CREATE_PROCESS_DEBUG_EVENT \n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//4.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;EXIT_THREAD_DEBUG_EVENT \n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//5.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;EXIT_PROCESS_DEBUG_EVENT \n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//6.</span></span><br><span class="line">		<span class="keyword">case</span> LOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;LOAD_DLL_DEBUG_EVENT \n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//7.</span></span><br><span class="line">		<span class="keyword">case</span> UNLOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;UNLOAD_DLL_DEBUG_EVENT \n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//8.</span></span><br><span class="line">		<span class="keyword">case</span> OUTPUT_DEBUG_STRING_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;OUTPUT_DEBUG_STRING_EVENT \n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		bRet = ContinueDebugEvent(debugEvent.dwProcessId, debugEvent.dwThreadId, DBG_CONTINUE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>进程被成功创建后，产生了一个异常事件。</p>
<blockquote>
<p>进程创建的步骤：</p>
<ol>
<li>映射EXE</li>
<li>创建内核对象EPROCESS</li>
<li>映射系统dll：ntdll.dll</li>
<li>创建线程内核对象ETHREAD</li>
<li>系统启动线程<ol>
<li>映射当前线程所需的其他DLL(会调用<strong>ntdll.LdrInitializeThunk</strong>）</li>
<li>主线程开始执行)</li>
</ol>
</li>
</ol>
</blockquote>
<h2 id="异常来源"><a href="#异常来源" class="headerlink" title="异常来源"></a>异常来源</h2><p>首先改为系统断点：</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230310163025978.png" alt="image-20230310163025978"></p>
<p>随便导入个：</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230310163210216.png" alt="image-20230310163210216"></p>
<p>可以看到有个int 3，断在了<code>ntdll.DbgBreakPoint</code>函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:7C92120E                 public _DbgBreakPoint@0</span><br><span class="line">.text:7C92120E _DbgBreakPoint@0 proc near              ; CODE XREF: LdrpRunInitializeRoutines(x):loc_7C95A534↓p</span><br><span class="line">.text:7C92120E                                         ; LdrpInitializeProcess(x,x,x,x,x):loc_7C95E60D↓p ...</span><br><span class="line">.text:7C92120E                 int     3               ; Trap to Debugger</span><br><span class="line">.text:7C92120F                 retn</span><br><span class="line">.text:7C92120F _DbgBreakPoint@0 endp</span><br></pre></td></tr></table></figure>

<p>看一下交叉引用：</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230310163423081.png" alt="image-20230310163423081"></p>
<p>这个就是进程初始化过程的相关函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:7C95E60D</span><br><span class="line">.text:7C95E60D loc_7C95E60D:                           ; CODE XREF: LdrpInitializeProcess(x,x,x,x,x)-4BB↑j</span><br><span class="line">.text:7C95E60D                 call    _DbgBreakPoint@0 ; DbgBreakPoint()</span><br><span class="line">.text:7C95E612                 mov     eax, [ebx+68h]</span><br><span class="line">.text:7C95E615                 shr     eax, 1</span><br><span class="line">.text:7C95E617                 and     al, 1</span><br><span class="line">.text:7C95E619                 mov     _ShowSnaps, al</span><br><span class="line">.text:7C95E61E                 jmp     loc_7C9410BC</span><br></pre></td></tr></table></figure>

<p>往上跟：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:7C9410B2 loc_7C9410B2:                           ; CODE XREF: LdrpInitializeProcess(x,x,x,x,x)+BCC↓j</span><br><span class="line">.text:7C9410B2                 cmp     [ebx+PEB.BeingDebugged], 0</span><br><span class="line">.text:7C9410B6                 jnz     loc_7C95E60D</span><br></pre></td></tr></table></figure>

<p>如果被用户模式调试器附加了就会call DbgBreakPoint() ，如果没有调试器附加就不会调用这个int 3</p>
<h2 id="简易调试器：附加"><a href="#简易调试器：附加" class="headerlink" title="简易调试器：附加"></a>简易调试器：附加</h2><p>示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUGGEE <span class="string">&quot;驱动管理.exe&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">GetProcessId</span><span class="params">(<span class="type">char</span> *processName)</span></span><br><span class="line">&#123;</span><br><span class="line">	HANDLE hProcSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (hProcSnap == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		ExitProcess(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	PROCESSENTRY32 pe32 = &#123; <span class="keyword">sizeof</span>(PROCESSENTRY32) &#125;;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span>(Process32First(hProcSnap, &amp;pe32))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;	</span><br><span class="line">            <span class="keyword">if</span>(pe32.th32ProcessID != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="built_in">strcmp</span>(pe32.szExeFile, processName) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">return</span> pe32.th32ProcessID;</span><br><span class="line">				&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">while</span>(Process32Next(hProcSnap, &amp;pe32));</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    CloseHandle(hProcSnap);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL nIsContinue = TRUE;</span><br><span class="line">	DEBUG_EVENT debugEvent = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1.附加调试进程</span></span><br><span class="line">	<span class="keyword">if</span>(!DebugActiveProcess(GetProcessId(DEBUGGEE)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//2.调试循环</span></span><br><span class="line">	<span class="keyword">while</span>(nIsContinue)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForDebugEvent(&amp;debugEvent, INFINITE);</span><br><span class="line">		<span class="keyword">if</span>(!bRet)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;WaitForDebugEvent error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">switch</span>(debugEvent.dwDebugEventCode)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//1.异常</span></span><br><span class="line">		<span class="keyword">case</span> EXCEPTION_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;EXCEPTION_DEBUG_EVENT %x %x %x \n&quot;</span>,</span><br><span class="line">				debugEvent.u.Exception.ExceptionRecord.ExceptionAddress,</span><br><span class="line">				debugEvent.u.Exception.ExceptionRecord.ExceptionCode,</span><br><span class="line">				debugEvent.u.Exception.ExceptionRecord.ExceptionFlags);</span><br><span class="line">			<span class="comment">//printf(&quot;EXCEPTION_DEBUG_EVENT\n&quot;);</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">//2.</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;CREATE_THREAD_DEBUG_EVENT\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">//3.</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;CREATE_PROCESS_DEBUG_EVENT\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">//4.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;EXIT_THREAD_DEBUG_EVENT\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">//5.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;EXIT_PROCESS_DEBUG_EVENT\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">//6.</span></span><br><span class="line">		<span class="keyword">case</span> LOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;LOAD_DLL_DEBUG_EVENT\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">//7.</span></span><br><span class="line">		<span class="keyword">case</span> UNLOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;UNLOAD_DLL_DEBUG_EVENT\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">//8.</span></span><br><span class="line">		<span class="keyword">case</span> OUTPUT_DEBUG_STRING_EVENT:</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;OUTPUT_DEBUG_STRING_EVENT\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		bRet = ContinueDebugEvent(debugEvent.dwProcessId, debugEvent.dwThreadId, DBG_CONTINUE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会得到与进程创建相同的信息，这些消息是<code>杜撰的调试信息</code>，就是<strong>ntoskrnl!NtDebugActiveProcess</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PAGE:0058C4B6                 push    eax             ; int</span><br><span class="line">PAGE:0058C4B7                 push    [ebp+Process]   ; FastMutex</span><br><span class="line">PAGE:0058C4BA                 push    esi             ; PROCESS</span><br><span class="line">PAGE:0058C4BB                 call    _DbgkpPostFakeProcessCreateMessages@12 ; 发送一个假的进程创建消息</span><br></pre></td></tr></table></figure>

<p>跟进去看一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">PAGE:0058B9C0 _DbgkpPostFakeProcessCreateMessages@12 proc near</span><br><span class="line">PAGE:0058B9C0                                         ; CODE XREF: NtDebugActiveProcess(x,x)+8A↓p</span><br><span class="line">PAGE:0058B9C0</span><br><span class="line">PAGE:0058B9C0 ApcState        = _KAPC_STATE ptr -20h</span><br><span class="line">PAGE:0058B9C0 var_8           = dword ptr -8</span><br><span class="line">PAGE:0058B9C0 Object          = dword ptr -4</span><br><span class="line">PAGE:0058B9C0 PROCESS         = dword ptr  8</span><br><span class="line">PAGE:0058B9C0 FastMutex       = dword ptr  0Ch</span><br><span class="line">PAGE:0058B9C0 arg_8           = dword ptr  10h</span><br><span class="line">PAGE:0058B9C0</span><br><span class="line">PAGE:0058B9C0                 mov     edi, edi</span><br><span class="line">PAGE:0058B9C2                 push    ebp</span><br><span class="line">PAGE:0058B9C3                 mov     ebp, esp</span><br><span class="line">PAGE:0058B9C5                 sub     esp, 20h</span><br><span class="line">PAGE:0058B9C8                 push    esi</span><br><span class="line">PAGE:0058B9C9                 push    edi</span><br><span class="line">PAGE:0058B9CA                 lea     eax, [ebp+ApcState]</span><br><span class="line">PAGE:0058B9CD                 push    eax             ; ApcState</span><br><span class="line">PAGE:0058B9CE                 push    [ebp+PROCESS]   ; PROCESS</span><br><span class="line">PAGE:0058B9D1                 call    _KeStackAttachProcess@8 ; KeStackAttachProcess(x,x)</span><br><span class="line">PAGE:0058B9D6                 lea     eax, [ebp+Object]</span><br><span class="line">PAGE:0058B9D9                 push    eax             ; int</span><br><span class="line">PAGE:0058B9DA                 lea     eax, [ebp+var_8]</span><br><span class="line">PAGE:0058B9DD                 push    eax             ; int</span><br><span class="line">PAGE:0058B9DE                 xor     edi, edi</span><br><span class="line">PAGE:0058B9E0                 push    edi             ; Object</span><br><span class="line">PAGE:0058B9E1                 push    [ebp+FastMutex] ; FastMutex</span><br><span class="line">PAGE:0058B9E4                 push    [ebp+PROCESS]   ; PVOID</span><br><span class="line">PAGE:0058B9E7                 call    _DbgkpPostFakeThreadMessages@20 ; 发送虚假的线程消息</span><br><span class="line">PAGE:0058B9EC                 mov     esi, eax</span><br><span class="line">PAGE:0058B9EE                 cmp     esi, edi</span><br><span class="line">PAGE:0058B9F0                 jl      short loc_58BA1B</span><br><span class="line">PAGE:0058B9F2                 push    [ebp+FastMutex] ; FastMutex</span><br><span class="line">PAGE:0058B9F5                 push    [ebp+var_8]     ; PVOID</span><br><span class="line">PAGE:0058B9F8                 push    [ebp+PROCESS]   ; Object</span><br><span class="line">PAGE:0058B9FB                 call    _DbgkpPostFakeModuleMessages@12 ; 发送虚假模块消息</span><br></pre></td></tr></table></figure>

<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ol>
<li>调试器在创建进程时，除了能得到进程创建、创建线程、模块加载等调试事件之外，还会收到一个异常事件。</li>
<li>异常来源于调试器创建进程时触发的<strong>系统断点</strong>，目的是给调试器一个中断的机会。</li>
<li>调试器在<strong>附加进程</strong>时，能够得到一份模拟的进程创建时产生的相关调试事件信息</li>
<li>这些虚假的调试事件信息<strong>可靠性较低</strong>，程序在执行过程中可能已经处理过部分信息。</li>
</ol>
<h1 id="04-异常处理流程"><a href="#04-异常处理流程" class="headerlink" title="04.异常处理流程"></a>04.异常处理流程</h1><blockquote>
<p>在调试过程中，不论是软件断点、硬件断点还是INT 3断点，都是通过异常来实现的。</p>
</blockquote>
<p>异常处理流程图：</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230311110109036.png" alt="image-20230311110109036"></p>
<h2 id="调试器与异常关系"><a href="#调试器与异常关系" class="headerlink" title="调试器与异常关系"></a>调试器与异常关系</h2><p>示例程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">100</span>;</span><br><span class="line">	<span class="type">int</span> y = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> z;</span><br><span class="line"></span><br><span class="line">	_try</span><br><span class="line">	&#123;</span><br><span class="line">		z = x / y;		<span class="comment">//除0异常</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;无法执行的代码 \n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	_except(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;SEH异常处理代码 \n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正常处理会输出，下面修改调试选项：</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230311110308508.png" alt="image-20230311110308508"></p>
<p>程序停住了：</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230311111044990.png" alt="image-20230311111044990"></p>
<p>修改ebp-20的值为1：</p>
<p>可以看到：</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230311111147695.png" alt="image-20230311111147695"></p>
<h2 id="未处理异常"><a href="#未处理异常" class="headerlink" title="未处理异常"></a>未处理异常</h2><p>最后一道防线：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__try</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line">__except(UnhandledExceptionFilter(GetExceptionInformation())</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//终止线程</span></span><br><span class="line">	<span class="comment">//终止进程</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UnhandledExceptionFilter</code>执行流程：</p>
<ol>
<li>通过<code>NtQueryInformationProcess</code>查询当前进程是否正在被调试，如果是，返回<code>EXCEPTION_CONTINUE_SEARCH</code>，此时会进入第二轮分发。</li>
<li>如果没有被调试：<ol>
<li>查询是否通过<code>SetUnhandledExceptionFilter</code>注册处理函数，如果有就调用。</li>
<li>如果没有通过<code>SetUnhandledExceptionFilter</code>注册处理函数，弹出窗口，让用户选择终止程序还是启动即时调试器。</li>
<li>如果用户没有启用即时调试器，那么该函数返回<code>EXCEPTION_EXECUTE_HANDLER</code>。</li>
</ol>
</li>
</ol>
<h3 id="理解UnhandledExceptionFilter执行流程"><a href="#理解UnhandledExceptionFilter执行流程" class="headerlink" title="理解UnhandledExceptionFilter执行流程"></a>理解UnhandledExceptionFilter执行流程</h3><p>示例代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">100</span>;</span><br><span class="line">	<span class="type">int</span> y = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> z;</span><br><span class="line"></span><br><span class="line">	_try</span><br><span class="line">	&#123;</span><br><span class="line">		z = x / y;		<span class="comment">//除0异常</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;无法执行的代码 \n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	_except(<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;SEH异常处理代码 \n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230311111507666.png" alt="image-20230311111507666"></p>
<ol>
<li>由于当前进程并未处于调试状态，因此不会调用<code>UnhandledExceptionFilter</code>。</li>
<li>由于当前程序并未使用<code>SetUnhandledExceptionFilter</code>注册处理函数，因此会让用户选择是否启动调试器。</li>
</ol>
<p>通过<code>UnhandledExceptionFilter</code>的这个性质，可以借此实现反调试。</p>
<h3 id="UnhandledExceptionFilter反调试"><a href="#UnhandledExceptionFilter反调试" class="headerlink" title="UnhandledExceptionFilter反调试"></a>UnhandledExceptionFilter反调试</h3><p>示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">DWORD g_Test = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">LONG NTAPI <span class="title function_">TopLevelExcepFilter</span><span class="params">(PEXCEPTION_POINTERS pExcepInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;顶级异常处理器修复异常 \n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	g_Test = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	SetUnhandledExceptionFilter(&amp;TopLevelExcepFilter);</span><br><span class="line"></span><br><span class="line">	r = x / g_Test;		<span class="comment">//除0异常</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;正常逻辑开始执行 \n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		Sleep(<span class="number">1000</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d \n&quot;</span>, i);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调试的时候会停住：<img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230311111947844.png" alt="image-20230311111947844"></p>
<p>正常双击可以运行：</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230311112041778.png" alt="image-20230311112041778"></p>
<h1 id="05-软件断点"><a href="#05-软件断点" class="headerlink" title="05.软件断点"></a>05.软件断点</h1><p>触发异常的方式：</p>
<ol>
<li>软件断点</li>
<li>硬件断点</li>
<li>内存断点</li>
</ol>
<h2 id="软件断点"><a href="#软件断点" class="headerlink" title="软件断点"></a>软件断点</h2><p>可以看到本质是将当前代码位置的字节码改为<code>0xCC</code>，即<code>INT3</code>：</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230311121728853.png" alt="image-20230311121728853"></p>
<h2 id="软件断点执行流程"><a href="#软件断点执行流程" class="headerlink" title="软件断点执行流程"></a>软件断点执行流程</h2><h3 id="被调试进程"><a href="#被调试进程" class="headerlink" title="被调试进程"></a>被调试进程</h3><ol>
<li>CPU检测到<code>INT 3</code>指令</li>
<li>查IDT表找到对应的中断处理函数</li>
<li><code>CommonDispatchException</code></li>
<li><code>KiDispatchException</code></li>
<li><code>DbgkForwardException</code>收集并发送调试事件(第一个参数：消息类型，第二个参数：是否挂起其他进程)</li>
</ol>
<h3 id="调试器进程"><a href="#调试器进程" class="headerlink" title="调试器进程"></a>调试器进程</h3><ol>
<li>循环判断</li>
<li>取出调试事件</li>
<li>列出信息：寄存器、内存</li>
<li>用户处理</li>
</ol>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>alt+t搜<code>_IDT</code>，找到三号断点</p>
<p>最终都会到<code>CommonDispatchException</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:00407B47 loc_407B47:                             ; CODE XREF: _KiTrap03+88↑j</span><br><span class="line">.text:00407B47                                         ; _KiTrap03+CF↓j</span><br><span class="line">.text:00407B47                 mov     esi, ecx</span><br><span class="line">.text:00407B49                 mov     edi, edx</span><br><span class="line">.text:00407B4B                 mov     edx, eax</span><br><span class="line">.text:00407B4D                 mov     ebx, [ebp+68h]</span><br><span class="line">.text:00407B50                 dec     ebx</span><br><span class="line">.text:00407B51                 mov     ecx, 3</span><br><span class="line">.text:00407B56                 mov     eax, 80000003h</span><br><span class="line">.text:00407B5B                 call    CommonDispatchException</span><br></pre></td></tr></table></figure>

<p><code>CommonDispatchException</code>会调异常分发函数<code>_KiDispatchException</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:004073F8 loc_4073F8:                             ; CODE XREF: CommonDispatchException+39↑j</span><br><span class="line">.text:004073F8                 and     eax, 1</span><br><span class="line">.text:004073FB                 push    1               ; char</span><br><span class="line">.text:004073FD                 push    eax             ; int</span><br><span class="line">.text:004073FE                 push    ebp             ; BugCheckParameter3</span><br><span class="line">.text:004073FF                 push    0               ; int</span><br><span class="line">.text:00407401                 push    ecx             ; ExceptionRecord</span><br><span class="line">.text:00407402                 call    _KiDispatchException@20 ; KiDispatchException(x,x,x,x,x)</span><br><span class="line">.text:00407407                 mov     esp, ebp</span><br><span class="line">.text:00407409                 jmp     Kei386EoiHelper@0 ; Kei386EoiHelper()</span><br></pre></td></tr></table></figure>

<p><code>KiDispatchException</code>最后会通过<code>_DbgkForwardException</code>发送调试事件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:0044B196 loc_44B196:                             ; CODE XREF: KiDispatchException(x,x,x,x,x)+1C5AD↑j</span><br><span class="line">.text:0044B196                 push    1</span><br><span class="line">.text:0044B198                 push    1</span><br><span class="line">.text:0044B19A                 push    esi</span><br><span class="line">.text:0044B19B                 call    _DbgkForwardException@12 ; 发送调试事件</span><br><span class="line">.text:0044B1A0                 test    al, al</span><br><span class="line">.text:0044B1A2                 jnz     loc_424AE4</span><br></pre></td></tr></table></figure>

<h3 id="处理软件断点"><a href="#处理软件断点" class="headerlink" title="处理软件断点"></a>处理软件断点</h3><p>示例代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUGGEE <span class="string">&quot;C:\\KmdManager.exe&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//被调试进程ID,进程句柄，OEP</span></span><br><span class="line">DWORD dwDebuggeePID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//被调试线程句柄</span></span><br><span class="line">HANDLE hDebuggeeThread = <span class="literal">NULL</span>;</span><br><span class="line">HANDLE hDebuggeeProcess = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//系统断点</span></span><br><span class="line">BOOL bIsSystemInt3 = TRUE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//被INT 3覆盖的数据</span></span><br><span class="line">CHAR OriginalCode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程上下文</span></span><br><span class="line">CONTEXT Context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">HANDLE</span> <span class="params">(__stdcall *FnOpenThread)</span> <span class="params">(DWORD, BOOL, DWORD)</span>;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">InitDebuggeeInfo</span><span class="params">(DWORD dwPID, HANDLE hProcess)</span></span><br><span class="line">&#123;</span><br><span class="line">	dwDebuggeePID = dwPID;</span><br><span class="line">	hDebuggeeProcess = hProcess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DWORD <span class="title function_">GetProcessId</span><span class="params">(LPTSTR lpProcessName)</span></span><br><span class="line">&#123;</span><br><span class="line">	HANDLE hProcessSnap = <span class="literal">NULL</span>;</span><br><span class="line">	PROCESSENTRY32 pe32 = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	</span><br><span class="line">	hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(hProcessSnap == (HANDLE)<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	pe32.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(Process32First(hProcessSnap, &amp;pe32))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">do</span> </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(lpProcessName, pe32.szExeFile))</span><br><span class="line">				<span class="keyword">return</span> (<span class="type">int</span>)pe32.th32ProcessID;</span><br><span class="line">		&#125; <span class="keyword">while</span> (Process32Next(hProcessSnap, &amp;pe32));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		CloseHandle(hProcessSnap);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">WaitForUserCommand</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line">	CHAR command;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;COMMAND&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">	command = getchar();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(command)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;g&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">Int3ExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1. 将INT 3修复为原来的数据（如果是系统断点，不用修复）</span></span><br><span class="line">	<span class="keyword">if</span>(bIsSystemInt3)</span><br><span class="line">	&#123;</span><br><span class="line">		bIsSystemInt3 = FALSE;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		WriteProcessMemory(hDebuggeeProcess, pExceptionInfo-&gt;ExceptionRecord.ExceptionAddress, &amp;OriginalCode, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2. 显示断点位置</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Int 3断点：0x%p \r\n&quot;</span>, pExceptionInfo-&gt;ExceptionRecord.ExceptionAddress);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//3. 获取线程上下文</span></span><br><span class="line">	Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">	GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//4. 修正EIP</span></span><br><span class="line">	Context.Eip--;</span><br><span class="line">	SetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//5. 显示反汇编代码、寄存器等</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//6. 等待用户命令</span></span><br><span class="line">	<span class="keyword">while</span>(bRet == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForUserCommand();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">AccessExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">SingleStepExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">ExceptionHandler</span><span class="params">(DEBUG_EVENT *pDebugEvent)</span></span><br><span class="line">&#123; </span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	EXCEPTION_DEBUG_INFO *pExceptionInfo = <span class="literal">NULL</span>;</span><br><span class="line">	pExceptionInfo = &amp;pDebugEvent-&gt;u.Exception;</span><br><span class="line">	<span class="comment">//得到线程句柄，后面要用</span></span><br><span class="line">	FnOpenThread MyOpenThread = (FnOpenThread)GetProcAddress(LoadLibrary(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;OpenThread&quot;</span>);</span><br><span class="line">	hDebuggeeThread = MyOpenThread(THREAD_ALL_ACCESS, FALSE, pDebugEvent-&gt;dwThreadId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(pExceptionInfo-&gt;ExceptionRecord.ExceptionCode)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">//INT 3异常</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_BREAKPOINT:</span><br><span class="line">		&#123;</span><br><span class="line">			bRet = Int3ExceptionProc(pExceptionInfo);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="comment">//访问异常</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_ACCESS_VIOLATION:</span><br><span class="line">		bRet = AccessExceptionProc(pExceptionInfo);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="comment">//单步执行</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_SINGLE_STEP:</span><br><span class="line">		bRet = SingleStepExceptionProc(pExceptionInfo);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">SetInt3BreakPoint</span><span class="params">(LPVOID addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	ReadProcessMemory(hDebuggeeProcess, addr, &amp;OriginalCode, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	BYTE int3[<span class="number">1</span>] = &#123; <span class="number">0xcc</span> &#125;;</span><br><span class="line"></span><br><span class="line">	WriteProcessMemory(hDebuggeeProcess, addr, int3, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL nIsContinue = TRUE;</span><br><span class="line">	DEBUG_EVENT debugEvent = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	DWORD dwContinue = DBG_CONTINUE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1.创建调试进程</span></span><br><span class="line">	STARTUPINFO startupInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	PROCESS_INFORMATION pInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	GetStartupInfo(&amp;startupInfo);</span><br><span class="line"></span><br><span class="line">	bRet = CreateProcess(DEBUGGEE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, DEBUG_PROCESS || DEBUG_ONLY_THIS_PROCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;startupInfo, &amp;pInfo);</span><br><span class="line">	<span class="keyword">if</span>(!bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateProcess error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hDebuggeeProcess = pInfo.hProcess;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2.调试循环</span></span><br><span class="line">	<span class="keyword">while</span>(nIsContinue)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForDebugEvent(&amp;debugEvent, INFINITE);</span><br><span class="line">		<span class="keyword">if</span>(!bRet)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;WaitForDebugEvent error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span>(debugEvent.dwDebugEventCode)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="comment">//1.异常</span></span><br><span class="line">		<span class="keyword">case</span> EXCEPTION_DEBUG_EVENT:</span><br><span class="line">			bRet = ExceptionHandler(&amp;debugEvent);</span><br><span class="line">			<span class="keyword">if</span>(!bRet)</span><br><span class="line">				dwContinue = DBG_EXCEPTION_NOT_HANDLED;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//2.</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//3.创建进程</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_PROCESS_DEBUG_EVENT:</span><br><span class="line">			SetInt3BreakPoint((PCHAR)debugEvent.u.CreateProcessInfo.lpStartAddress);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//4.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//5.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//6.</span></span><br><span class="line">		<span class="keyword">case</span> LOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//7.</span></span><br><span class="line">		<span class="keyword">case</span> UNLOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//8.</span></span><br><span class="line">		<span class="keyword">case</span> OUTPUT_DEBUG_STRING_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		bRet = ContinueDebugEvent(debugEvent.dwProcessId, debugEvent.dwThreadId, DBG_CONTINUE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230311230028195.png" alt="image-20230311230028195"></p>
<h1 id="06-内存断点"><a href="#06-内存断点" class="headerlink" title="06.内存断点"></a>06.内存断点</h1><p>当需要在某块内存被访问时产生中断，可以使用内存断点。</p>
<p><strong>内存断点能够分为两种类型：</strong></p>
<ol>
<li><strong>内存访问</strong>：内存被读写时产生中断。</li>
<li><strong>内存写入</strong>：内存被写入时产生中断。</li>
</ol>
<p><code>VirtualProtecteEx</code>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">VirtualProtectEx</span><span class="params">(</span></span><br><span class="line"><span class="params">	HANDLE hProcess,        <span class="comment">// handle to process</span></span></span><br><span class="line"><span class="params">	LPVOID lpAddress,       <span class="comment">// region of committed pages</span></span></span><br><span class="line"><span class="params">	SIZE_T dwSize,          <span class="comment">// size of region</span></span></span><br><span class="line"><span class="params">	DWORD flNewProtect,     <span class="comment">// desired access protection</span></span></span><br><span class="line"><span class="params">	PDWORD lpflOldProtect   <span class="comment">// old protection</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>内存访问</strong>：将指定内存的属性修改为<strong>PAGE_NOACCESS</strong>（修改后，PTE的P位等于0）<br><strong>内存写入</strong>：将指定内存的属性修改为<strong>PAGE_EXECUTE_READ</strong>（修改后，PTE的P位等于1，R/W位等于0）</p>
<h2 id="内存断点执行流程"><a href="#内存断点执行流程" class="headerlink" title="内存断点执行流程"></a>内存断点执行流程</h2><h3 id="被调试进程-1"><a href="#被调试进程-1" class="headerlink" title="被调试进程"></a>被调试进程</h3><ol>
<li>CPU访问错误的内存地址，触发页异常</li>
<li>查IDT表找到对应的中断处理函数（<code>nt!_KiTrap0E</code>）</li>
<li><code>CommonDispatchException</code></li>
<li><code>KiDispatchException</code></li>
<li><code>DbgkForwardException</code>收集并发送调试事件</li>
</ol>
<h3 id="调试器进程-1"><a href="#调试器进程-1" class="headerlink" title="调试器进程"></a>调试器进程</h3><ol>
<li>循环判断</li>
<li>取出调试事件</li>
<li>列出消息（寄存器/内存）</li>
<li>用户处理</li>
</ol>
<h3 id="处理内存断点"><a href="#处理内存断点" class="headerlink" title="处理内存断点"></a>处理内存断点</h3><p>示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUGGEE <span class="string">&quot;C:\\KmdManager.exe&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//被调试进程ID,进程句柄，OEP</span></span><br><span class="line">DWORD dwDebuggeePID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//被调试线程句柄</span></span><br><span class="line">HANDLE hDebuggeeThread = <span class="literal">NULL</span>;</span><br><span class="line">HANDLE hDebuggeeProcess = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//系统断点</span></span><br><span class="line">BOOL bIsSystemInt3 = TRUE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//被INT 3覆盖的数据</span></span><br><span class="line">CHAR OriginalCode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//原始内存属性</span></span><br><span class="line">DWORD dwOriginalProtect;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程上下文</span></span><br><span class="line">CONTEXT Context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">HANDLE</span> <span class="params">(__stdcall *FnOpenThread)</span> <span class="params">(DWORD, BOOL, DWORD)</span>;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">InitDebuggeeInfo</span><span class="params">(DWORD dwPID, HANDLE hProcess)</span></span><br><span class="line">&#123;</span><br><span class="line">	dwDebuggeePID = dwPID;</span><br><span class="line">	hDebuggeeProcess = hProcess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DWORD <span class="title function_">GetProcessId</span><span class="params">(LPTSTR lpProcessName)</span></span><br><span class="line">&#123;</span><br><span class="line">	HANDLE hProcessSnap = <span class="literal">NULL</span>;</span><br><span class="line">	PROCESSENTRY32 pe32 = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	</span><br><span class="line">	hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(hProcessSnap == (HANDLE)<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	pe32.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(Process32First(hProcessSnap, &amp;pe32))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">do</span> </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(lpProcessName, pe32.szExeFile))</span><br><span class="line">				<span class="keyword">return</span> (<span class="type">int</span>)pe32.th32ProcessID;</span><br><span class="line">		&#125; <span class="keyword">while</span> (Process32Next(hProcessSnap, &amp;pe32));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		CloseHandle(hProcessSnap);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">WaitForUserCommand</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line">	CHAR command;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;COMMAND&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">	command = getchar();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(command)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;g&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">Int3ExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1. 将INT 3修复为原来的数据（如果是系统断点，不用修复）</span></span><br><span class="line">	<span class="keyword">if</span>(bIsSystemInt3)</span><br><span class="line">	&#123;</span><br><span class="line">		bIsSystemInt3 = FALSE;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		WriteProcessMemory(hDebuggeeProcess, pExceptionInfo-&gt;ExceptionRecord.ExceptionAddress, &amp;OriginalCode, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2. 显示断点位置</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Int 3断点：0x%p \r\n&quot;</span>, pExceptionInfo-&gt;ExceptionRecord.ExceptionAddress);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//3. 获取线程上下文</span></span><br><span class="line">	Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">	GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//4. 修正EIP</span></span><br><span class="line">	Context.Eip--;</span><br><span class="line">	SetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//5. 显示反汇编代码、寄存器等</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//6. 等待用户命令</span></span><br><span class="line">	<span class="keyword">while</span>(bRet == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForUserCommand();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">AccessExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line">	DWORD dwAccessFlag;		<span class="comment">//访问类型 0为读 1为写</span></span><br><span class="line">	DWORD dwAccessAddr;		<span class="comment">//访问地址</span></span><br><span class="line">	DWORD dwProtect;		<span class="comment">//内存属性</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//1. 获取异常信息，修改内存属性</span></span><br><span class="line">	dwAccessFlag = pExceptionInfo-&gt;ExceptionRecord.ExceptionInformation[<span class="number">0</span>];</span><br><span class="line">	dwAccessAddr = pExceptionInfo-&gt;ExceptionRecord.ExceptionInformation[<span class="number">1</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;内存断点： %x %x \n&quot;</span>, dwAccessFlag, dwAccessAddr);</span><br><span class="line">	VirtualProtectEx(hDebuggeeProcess, (VOID*)dwAccessAddr, <span class="number">1</span>, dwOriginalProtect, &amp;dwProtect);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//2. 获取线程上下文</span></span><br><span class="line">	Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">	GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">	<span class="comment">//3. 修正EIP(内存访问异常，不需要修正EIP)</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Eip: 0x%p \n&quot;</span>, Context.Eip);</span><br><span class="line">	<span class="comment">//4. 显示汇编/寄存器等信息</span></span><br><span class="line">	<span class="comment">//5. 等待用户命令</span></span><br><span class="line">	<span class="keyword">while</span>(bRet == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForUserCommand();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">SingleStepExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">ExceptionHandler</span><span class="params">(DEBUG_EVENT *pDebugEvent)</span></span><br><span class="line">&#123; </span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	EXCEPTION_DEBUG_INFO *pExceptionInfo = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	pExceptionInfo = &amp;pDebugEvent-&gt;u.Exception;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//得到线程句柄，后面要用</span></span><br><span class="line">	FnOpenThread MyOpenThread = (FnOpenThread)GetProcAddress(LoadLibrary(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;OpenThread&quot;</span>);</span><br><span class="line">	hDebuggeeThread = MyOpenThread(THREAD_ALL_ACCESS, FALSE, pDebugEvent-&gt;dwThreadId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(pExceptionInfo-&gt;ExceptionRecord.ExceptionCode)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">//INT 3异常</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_BREAKPOINT:</span><br><span class="line">		&#123;</span><br><span class="line">			bRet = Int3ExceptionProc(pExceptionInfo);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="comment">//访问异常</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_ACCESS_VIOLATION:</span><br><span class="line">		bRet = AccessExceptionProc(pExceptionInfo);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="comment">//单步执行</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_SINGLE_STEP:</span><br><span class="line">		bRet = SingleStepExceptionProc(pExceptionInfo);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">SetInt3BreakPoint</span><span class="params">(LPVOID addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	CHAR int3 = <span class="number">0xCC</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//1. 备份</span></span><br><span class="line">	ReadProcessMemory(hDebuggeeProcess, addr, &amp;OriginalCode, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">//2. 修改</span></span><br><span class="line">	WriteProcessMemory(hDebuggeeProcess, addr, &amp;int3, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">SetMemBreakPoint</span><span class="params">(PCHAR pAddress)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//1. 访问断点</span></span><br><span class="line">	VirtualProtectEx(hDebuggeeProcess, pAddress, <span class="number">1</span>, PAGE_NOACCESS, &amp;dwOriginalProtect);</span><br><span class="line">	<span class="comment">//2. 写入断点</span></span><br><span class="line">	<span class="comment">//VirtualProtectEx(hDebuggeeProcess, pAddress, 1, PAGE_EXECUTE_READ, &amp;dwOriginalProtect);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL nIsContinue = TRUE;</span><br><span class="line">	DEBUG_EVENT debugEvent = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	DWORD dwContinue = DBG_CONTINUE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1.创建调试进程</span></span><br><span class="line">	STARTUPINFO startupInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	PROCESS_INFORMATION pInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	GetStartupInfo(&amp;startupInfo);</span><br><span class="line"></span><br><span class="line">	bRet = CreateProcess(DEBUGGEE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, DEBUG_PROCESS || DEBUG_ONLY_THIS_PROCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;startupInfo, &amp;pInfo);</span><br><span class="line">	<span class="keyword">if</span>(!bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateProcess error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hDebuggeeProcess = pInfo.hProcess;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2.调试循环</span></span><br><span class="line">	<span class="keyword">while</span>(nIsContinue)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForDebugEvent(&amp;debugEvent, INFINITE);</span><br><span class="line">		<span class="keyword">if</span>(!bRet)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;WaitForDebugEvent error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span>(debugEvent.dwDebugEventCode)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="comment">//1.异常</span></span><br><span class="line">		<span class="keyword">case</span> EXCEPTION_DEBUG_EVENT:</span><br><span class="line">			bRet = ExceptionHandler(&amp;debugEvent);</span><br><span class="line">			<span class="keyword">if</span>(!bRet)</span><br><span class="line">				dwContinue = DBG_EXCEPTION_NOT_HANDLED;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//2.</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//3.创建进程</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="comment">//int3 断点</span></span><br><span class="line">			<span class="comment">//SetInt3BreakPoint((PCHAR)debugEvent.u.CreateProcessInfo.lpStartAddress);</span></span><br><span class="line">			<span class="comment">//内存断点</span></span><br><span class="line">			SetMemBreakPoint((PCHAR)debugEvent.u.CreateProcessInfo.lpStartAddress);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//4.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//5.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//6.</span></span><br><span class="line">		<span class="keyword">case</span> LOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//7.</span></span><br><span class="line">		<span class="keyword">case</span> UNLOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//8.</span></span><br><span class="line">		<span class="keyword">case</span> OUTPUT_DEBUG_STRING_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		bRet = ContinueDebugEvent(debugEvent.dwProcessId, debugEvent.dwThreadId, DBG_CONTINUE);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="07-硬件断点"><a href="#07-硬件断点" class="headerlink" title="07.硬件断点"></a>07.硬件断点</h1><h2 id="硬件断点"><a href="#硬件断点" class="headerlink" title="硬件断点"></a>硬件断点</h2><ol>
<li>与软件断点与内存断点不同，<strong>硬件断点</strong>不依赖被调试程序，而是依赖于CPU中的<strong>调试寄存器</strong>。</li>
<li>调试寄存器有<strong>8个</strong>，分别为<strong>Dr0~Dr7</strong>。</li>
<li>用户最多能够设置4个硬件断点，这是由于只有Dr0~Dr3用于存储线性地址。</li>
<li>Dr4和Dr5是保留的。</li>
</ol>
<p>每个线程都拥有一份独立的寄存器，切换线程时，寄存器的值也会被切换。</p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230312115603417.png" alt="image-20230312115603417"></p>
<p>设置硬件断点：</p>
<ol>
<li>Dr0~Dr3用于设置硬件断点，由于只有4个断点寄存器，所以最多只能设置4个硬件调试断点。</li>
<li>Dr7是最重要的寄存器：<ol>
<li>L0/G0 ~ L3/G3：控制Dr0~Dr3是否有效，局部还是全局；每次异常后，Lx都被清零,Gx不清零。</li>
<li>断点长度(LENx)：00(1字节)、01(2字节)、11(4字节)</li>
<li>断点类型(R/Wx)：00(执行断点)、01(写入断点)、11(访问断点)</li>
</ol>
</li>
</ol>
<p>硬件断点触发后走的中断处理函数是：<code>nt!_KiTrap01</code></p>
<p>示例代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUGGEE <span class="string">&quot;C:\\KmdManager.exe&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//被调试进程ID,进程句柄，OEP</span></span><br><span class="line">DWORD dwDebuggeePID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//被调试线程句柄</span></span><br><span class="line">HANDLE hDebuggeeThread = <span class="literal">NULL</span>;</span><br><span class="line">HANDLE hDebuggeeProcess = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//系统断点</span></span><br><span class="line">BOOL bIsSystemInt3 = TRUE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//被INT 3覆盖的数据</span></span><br><span class="line">CHAR OriginalCode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程上下文</span></span><br><span class="line">CONTEXT Context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">HANDLE</span> <span class="params">(__stdcall *FnOpenThread)</span> <span class="params">(DWORD, BOOL, DWORD)</span>;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">InitDebuggeeInfo</span><span class="params">(DWORD dwPID, HANDLE hProcess)</span></span><br><span class="line">&#123;</span><br><span class="line">	dwDebuggeePID = dwPID;</span><br><span class="line">	hDebuggeeProcess = hProcess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DWORD <span class="title function_">GetProcessId</span><span class="params">(LPTSTR lpProcessName)</span></span><br><span class="line">&#123;</span><br><span class="line">	HANDLE hProcessSnap = <span class="literal">NULL</span>;</span><br><span class="line">	PROCESSENTRY32 pe32 = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	</span><br><span class="line">	hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(hProcessSnap == (HANDLE)<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	pe32.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(Process32First(hProcessSnap, &amp;pe32))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">do</span> </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(lpProcessName, pe32.szExeFile))</span><br><span class="line">				<span class="keyword">return</span> (<span class="type">int</span>)pe32.th32ProcessID;</span><br><span class="line">		&#125; <span class="keyword">while</span> (Process32Next(hProcessSnap, &amp;pe32));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		CloseHandle(hProcessSnap);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">WaitForUserCommand</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line">	CHAR command;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;COMMAND&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">	command = getchar();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(command)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;g&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">SetHardBreakPoint</span><span class="params">(PVOID pAddress)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//1. 获取线程上下文</span></span><br><span class="line">	Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">	GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">	<span class="comment">//2. 设置断点位置</span></span><br><span class="line">	Context.Dr0 = (DWORD)pAddress;</span><br><span class="line">	Context.Dr7 |= <span class="number">1</span>;</span><br><span class="line">	<span class="comment">//3. 设置断点长度和类型</span></span><br><span class="line">	Context.Dr7 &amp;= <span class="number">0xfff0ffff</span>;	<span class="comment">//执行断点（16、17位 置0） 1字节（18、19位 置0）</span></span><br><span class="line">	<span class="comment">//5. 设置线程上下文</span></span><br><span class="line">	SetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">Int3ExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1. 将INT 3修复为原来的数据（如果是系统断点，不用修复）</span></span><br><span class="line">	<span class="keyword">if</span>(bIsSystemInt3)</span><br><span class="line">	&#123;</span><br><span class="line">		bIsSystemInt3 = FALSE;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		WriteProcessMemory(hDebuggeeProcess, pExceptionInfo-&gt;ExceptionRecord.ExceptionAddress, &amp;OriginalCode, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2. 显示断点位置</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Int 3断点：0x%p \r\n&quot;</span>, pExceptionInfo-&gt;ExceptionRecord.ExceptionAddress);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//3. 获取线程上下文</span></span><br><span class="line">	Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">	GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//4. 修正EIP</span></span><br><span class="line">	Context.Eip--;</span><br><span class="line">	SetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//5. 显示反汇编代码、寄存器等</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	硬件断点需要设置在被调试进程的的线程上下文中。</span></span><br><span class="line"><span class="comment">	因此当被调试程序触发调试器设置的INT 3断点时，此时设置硬件断点较为合理。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	SetHardBreakPoint((PVOID)((DWORD)pExceptionInfo-&gt;ExceptionRecord.ExceptionAddress+<span class="number">1</span>));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//6. 等待用户命令</span></span><br><span class="line">	<span class="keyword">while</span>(bRet == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForUserCommand();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">AccessExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">SingleStepExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1. 获取线程上下文</span></span><br><span class="line">	Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">	GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">	<span class="comment">//2. 判断是否是硬件断点导致的异常</span></span><br><span class="line">	<span class="keyword">if</span>(Context.Dr6 &amp; <span class="number">0xF</span>)	<span class="comment">//B0~B3不为空 硬件断点</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//2.1 显示断点信息</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;硬件断点：%x 0x%p \n&quot;</span>, Context.Dr7&amp;<span class="number">0x00030000</span>, Context.Dr0);</span><br><span class="line">		<span class="comment">//2.2 将断点去除</span></span><br><span class="line">		Context.Dr0 = <span class="number">0</span>;</span><br><span class="line">		Context.Dr7 &amp;= <span class="number">0xfffffffe</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>	<span class="comment">//单步异常</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//2.1 显示断点信息</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;单步：0x%p \n&quot;</span>, Context.Eip);</span><br><span class="line">		<span class="comment">//2.2 将断点去除</span></span><br><span class="line">		Context.Dr7 &amp;= <span class="number">0xfffffeff</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//6. 等待用户命令</span></span><br><span class="line">	<span class="keyword">while</span>(bRet == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForUserCommand();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">ExceptionHandler</span><span class="params">(DEBUG_EVENT *pDebugEvent)</span></span><br><span class="line">&#123; </span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	EXCEPTION_DEBUG_INFO *pExceptionInfo = <span class="literal">NULL</span>;</span><br><span class="line">	pExceptionInfo = &amp;pDebugEvent-&gt;u.Exception;</span><br><span class="line">	<span class="comment">//得到线程句柄，后面要用</span></span><br><span class="line">	FnOpenThread MyOpenThread = (FnOpenThread)GetProcAddress(LoadLibrary(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;OpenThread&quot;</span>);</span><br><span class="line">	hDebuggeeThread = MyOpenThread(THREAD_ALL_ACCESS, FALSE, pDebugEvent-&gt;dwThreadId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(pExceptionInfo-&gt;ExceptionRecord.ExceptionCode)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">//INT 3异常</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_BREAKPOINT:</span><br><span class="line">		bRet = Int3ExceptionProc(pExceptionInfo);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="comment">//访问异常</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_ACCESS_VIOLATION:</span><br><span class="line">		bRet = AccessExceptionProc(pExceptionInfo);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="comment">//单步执行</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_SINGLE_STEP:</span><br><span class="line">		bRet = SingleStepExceptionProc(pExceptionInfo);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">SetInt3BreakPoint</span><span class="params">(LPVOID addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	CHAR int3 = <span class="number">0xCC</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//1. 备份</span></span><br><span class="line">	ReadProcessMemory(hDebuggeeProcess, addr, &amp;OriginalCode, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">//2. 修改</span></span><br><span class="line">	WriteProcessMemory(hDebuggeeProcess, addr, &amp;int3, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL nIsContinue = TRUE;</span><br><span class="line">	DEBUG_EVENT debugEvent = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	DWORD dwContinue = DBG_CONTINUE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1.创建调试进程</span></span><br><span class="line">	STARTUPINFO startupInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	PROCESS_INFORMATION pInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	GetStartupInfo(&amp;startupInfo);</span><br><span class="line"></span><br><span class="line">	bRet = CreateProcess(DEBUGGEE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, DEBUG_PROCESS || DEBUG_ONLY_THIS_PROCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;startupInfo, &amp;pInfo);</span><br><span class="line">	<span class="keyword">if</span>(!bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateProcess error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hDebuggeeProcess = pInfo.hProcess;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2.调试循环</span></span><br><span class="line">	<span class="keyword">while</span>(nIsContinue)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForDebugEvent(&amp;debugEvent, INFINITE);</span><br><span class="line">		<span class="keyword">if</span>(!bRet)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;WaitForDebugEvent error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span>(debugEvent.dwDebugEventCode)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="comment">//1.异常</span></span><br><span class="line">		<span class="keyword">case</span> EXCEPTION_DEBUG_EVENT:</span><br><span class="line">			bRet = ExceptionHandler(&amp;debugEvent);</span><br><span class="line">			<span class="keyword">if</span>(!bRet)</span><br><span class="line">				dwContinue = DBG_EXCEPTION_NOT_HANDLED;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//2.</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//3.创建进程</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="comment">//设置INT 3断点</span></span><br><span class="line">			SetInt3BreakPoint((PCHAR)debugEvent.u.CreateProcessInfo.lpStartAddress);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//4.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//5.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//6.</span></span><br><span class="line">		<span class="keyword">case</span> LOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//7.</span></span><br><span class="line">		<span class="keyword">case</span> UNLOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//8.</span></span><br><span class="line">		<span class="keyword">case</span> OUTPUT_DEBUG_STRING_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		bRet = ContinueDebugEvent(debugEvent.dwProcessId, debugEvent.dwThreadId, DBG_CONTINUE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="08-单步异常"><a href="#08-单步异常" class="headerlink" title="08.单步异常"></a>08.单步异常</h1><p>不单只有硬件断点能触发单步异常，EFLAGS寄存器也可以</p>
<p>设置单步运行：TF位置1</p>
<p>处理单步异常：<code>STATUS_SINGLE_STEP</code></p>
<p><img src="/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/image-20230312120730668.png" alt="image-20230312120730668"></p>
<p>代码和上面一样</p>
<h1 id="09-单步步过"><a href="#09-单步步过" class="headerlink" title="09.单步步过"></a>09.单步步过</h1><ol>
<li>当遇到CALL指令时，若无需进入函数内部进行调试，可以使用<strong>单步步过</strong>。</li>
<li>与单步步入不同的是，<strong>单步步过</strong>的实现依赖于<strong>软件断点</strong>或<strong>硬件断点</strong>。</li>
</ol>
<p>思路：</p>
<ol>
<li>判断当前指令是否为<strong>CALL指令</strong></li>
<li>若<strong>不是</strong>CALL指令，设置TF为1触发<strong>单步异常</strong></li>
<li>若<strong>是</strong>CALL指令，判断<strong>OPCODE</strong>是<strong>E8</strong>还是<strong>FF15</strong></li>
<li>若OPCODE是<strong>E8</strong>，在<strong>当前地址之后的第5个字节</strong>设置<strong>软件断点</strong>（E8指令占5个字节）</li>
<li>若OPCODE是<strong>FF15</strong>，在<strong>当前地址之后的第6个字节</strong>设置<strong>软件断点</strong>（FF15指令占6个字节）</li>
</ol>
<p>示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUGGEE <span class="string">&quot;C:\\KmdManager.exe&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//被调试进程ID,进程句柄，OEP</span></span><br><span class="line">DWORD dwDebuggeePID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//被调试线程句柄</span></span><br><span class="line">HANDLE hDebuggeeThread = <span class="literal">NULL</span>;</span><br><span class="line">HANDLE hDebuggeeProcess = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//系统断点</span></span><br><span class="line">BOOL bIsSystemInt3 = TRUE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//被INT 3覆盖的数据</span></span><br><span class="line">CHAR cOriginalCode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程上下文</span></span><br><span class="line">CONTEXT Context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">HANDLE</span> <span class="params">(__stdcall *FnOpenThread)</span> <span class="params">(DWORD, BOOL, DWORD)</span>;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">InitDebuggeeInfo</span><span class="params">(DWORD dwPID, HANDLE hProcess)</span></span><br><span class="line">&#123;</span><br><span class="line">	dwDebuggeePID = dwPID;</span><br><span class="line">	hDebuggeeProcess = hProcess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DWORD <span class="title function_">GetProcessId</span><span class="params">(LPTSTR lpProcessName)</span></span><br><span class="line">&#123;</span><br><span class="line">	HANDLE hProcessSnap = <span class="literal">NULL</span>;</span><br><span class="line">	PROCESSENTRY32 pe32 = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	</span><br><span class="line">	hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(hProcessSnap == (HANDLE)<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	pe32.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(Process32First(hProcessSnap, &amp;pe32))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">do</span> </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(lpProcessName, pe32.szExeFile))</span><br><span class="line">				<span class="keyword">return</span> (<span class="type">int</span>)pe32.th32ProcessID;</span><br><span class="line">		&#125; <span class="keyword">while</span> (Process32Next(hProcessSnap, &amp;pe32));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		CloseHandle(hProcessSnap);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">SetInt3BreakPoint</span><span class="params">(LPVOID addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	CHAR int3 = <span class="number">0xCC</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//1. 备份</span></span><br><span class="line">	ReadProcessMemory(hDebuggeeProcess, addr, &amp;cOriginalCode, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">//2. 修改</span></span><br><span class="line">	WriteProcessMemory(hDebuggeeProcess, addr, &amp;int3, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">WaitForUserCommand</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line">	CHAR command;</span><br><span class="line">	WORD wBuffer;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;COMMAND&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">	command = getchar();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(command)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="comment">//1. 获取线程上下文</span></span><br><span class="line">		Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">		GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">		<span class="comment">//2. 设置陷阱标志位</span></span><br><span class="line">		Context.EFlags |= <span class="number">0x100</span>;</span><br><span class="line">		<span class="comment">//3. 设置线程上下文</span></span><br><span class="line">		SetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="comment">//1. 获取线程上下文</span></span><br><span class="line">		Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">		GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">		<span class="comment">//2. 读取当前EIP指向的机器码</span></span><br><span class="line">		ReadProcessMemory(hDebuggeeProcess, (LPVOID)Context.Eip, &amp;wBuffer, <span class="number">2</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span>((wBuffer &amp; <span class="number">0xFF</span>) == <span class="number">0xE8</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//3. 在当前地址之后的第5个字节设置软件断点（E8指令占5个字节）</span></span><br><span class="line">			SetInt3BreakPoint((LPVOID)(Context.Eip+<span class="number">5</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(wBuffer == <span class="number">0x15FF</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//3. 在当前地址之后的第6个字节设置软件断点（FF15指令占6个字节）</span></span><br><span class="line">			SetInt3BreakPoint((LPVOID)(Context.Eip+<span class="number">6</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//3. 不是CALL指令，设置陷阱标志位触发单步异常即可</span></span><br><span class="line">			Context.EFlags |= <span class="number">0x100</span>;</span><br><span class="line">			<span class="comment">//4. 设置线程上下文</span></span><br><span class="line">			SetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;g&#x27;</span>:</span><br><span class="line">		bRet = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">SetHardBreakPoint</span><span class="params">(PVOID pAddress)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//1. 获取线程上下文</span></span><br><span class="line">	Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">	GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">	<span class="comment">//2. 设置断点位置</span></span><br><span class="line">	Context.Dr0 = (DWORD)pAddress;</span><br><span class="line">	Context.Dr7 |= <span class="number">1</span>;</span><br><span class="line">	<span class="comment">//3. 设置断点长度和类型</span></span><br><span class="line">	Context.Dr7 &amp;= <span class="number">0xfff0ffff</span>;	<span class="comment">//执行断点（16、17位 置0） 1字节（18、19位 置0）</span></span><br><span class="line">	<span class="comment">//5. 设置线程上下文</span></span><br><span class="line">	SetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">Int3ExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1. 将INT 3修复为原来的数据（如果是系统断点，不用修复）</span></span><br><span class="line">	<span class="keyword">if</span>(bIsSystemInt3)</span><br><span class="line">	&#123;</span><br><span class="line">		bIsSystemInt3 = FALSE;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		WriteProcessMemory(hDebuggeeProcess, pExceptionInfo-&gt;ExceptionRecord.ExceptionAddress, &amp;cOriginalCode, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2. 显示断点位置</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Int 3断点：0x%p \r\n&quot;</span>, pExceptionInfo-&gt;ExceptionRecord.ExceptionAddress);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//3. 获取线程上下文</span></span><br><span class="line">	Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">	GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//4. 修正EIP</span></span><br><span class="line">	Context.Eip--;</span><br><span class="line">	SetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//5. 显示反汇编代码、寄存器等</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	硬件断点需要设置在被调试进程的的线程上下文中。</span></span><br><span class="line"><span class="comment">	因此当被调试程序触发调试器设置的INT 3断点时，此时设置硬件断点较为合理。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="comment">//SetHardBreakPoint((PVOID)((DWORD)pExceptionInfo-&gt;ExceptionRecord.ExceptionAddress+1));</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//6. 等待用户命令</span></span><br><span class="line">	<span class="keyword">while</span>(bRet == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForUserCommand();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">AccessExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">SingleStepExceptionProc</span><span class="params">(EXCEPTION_DEBUG_INFO *pExceptionInfo)</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1. 获取线程上下文</span></span><br><span class="line">	Context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">	GetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">	<span class="comment">//2. 判断是否是硬件断点导致的异常</span></span><br><span class="line">	<span class="keyword">if</span>(Context.Dr6 &amp; <span class="number">0xF</span>)	<span class="comment">//B0~B3不为空 硬件断点</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//2.1 显示断点信息</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;硬件断点：%x 0x%p \n&quot;</span>, Context.Dr7&amp;<span class="number">0x00030000</span>, Context.Dr0);</span><br><span class="line">		<span class="comment">//2.2 将断点去除</span></span><br><span class="line">		Context.Dr0 = <span class="number">0</span>;</span><br><span class="line">		Context.Dr7 &amp;= <span class="number">0xfffffffe</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>	<span class="comment">//单步异常</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//2.1 显示断点信息</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;单步异常：0x%p \n&quot;</span>, Context.Eip);</span><br><span class="line">		<span class="comment">//2.2 将断点去除</span></span><br><span class="line">		Context.Dr7 &amp;= <span class="number">0xfffffeff</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//3.设置线程上下文</span></span><br><span class="line">	SetThreadContext(hDebuggeeThread, &amp;Context);</span><br><span class="line">	<span class="comment">//4. 显示寄存器信息/反汇编代码</span></span><br><span class="line">	<span class="comment">//...略</span></span><br><span class="line">	<span class="comment">//5. 等待用户命令</span></span><br><span class="line">	<span class="keyword">while</span>(bRet == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForUserCommand();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">ExceptionHandler</span><span class="params">(DEBUG_EVENT *pDebugEvent)</span></span><br><span class="line">&#123; </span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	EXCEPTION_DEBUG_INFO *pExceptionInfo = <span class="literal">NULL</span>;</span><br><span class="line">	pExceptionInfo = &amp;pDebugEvent-&gt;u.Exception;</span><br><span class="line">	<span class="comment">//得到线程句柄，后面要用</span></span><br><span class="line">	FnOpenThread MyOpenThread = (FnOpenThread)GetProcAddress(LoadLibrary(<span class="string">&quot;kernel32.dll&quot;</span>), <span class="string">&quot;OpenThread&quot;</span>);</span><br><span class="line">	hDebuggeeThread = MyOpenThread(THREAD_ALL_ACCESS, FALSE, pDebugEvent-&gt;dwThreadId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(pExceptionInfo-&gt;ExceptionRecord.ExceptionCode)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">//INT 3异常</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_BREAKPOINT:</span><br><span class="line">		bRet = Int3ExceptionProc(pExceptionInfo);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="comment">//访问异常</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_ACCESS_VIOLATION:</span><br><span class="line">		bRet = AccessExceptionProc(pExceptionInfo);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="comment">//单步执行</span></span><br><span class="line">	<span class="keyword">case</span> EXCEPTION_SINGLE_STEP:</span><br><span class="line">		bRet = SingleStepExceptionProc(pExceptionInfo);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL nIsContinue = TRUE;</span><br><span class="line">	DEBUG_EVENT debugEvent = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	BOOL bRet = TRUE;</span><br><span class="line">	DWORD dwContinue = DBG_CONTINUE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1.创建调试进程</span></span><br><span class="line">	STARTUPINFO startupInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	PROCESS_INFORMATION pInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	GetStartupInfo(&amp;startupInfo);</span><br><span class="line"></span><br><span class="line">	bRet = CreateProcess(DEBUGGEE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, DEBUG_PROCESS || DEBUG_ONLY_THIS_PROCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;startupInfo, &amp;pInfo);</span><br><span class="line">	<span class="keyword">if</span>(!bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateProcess error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hDebuggeeProcess = pInfo.hProcess;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2.调试循环</span></span><br><span class="line">	<span class="keyword">while</span>(nIsContinue)</span><br><span class="line">	&#123;</span><br><span class="line">		bRet = WaitForDebugEvent(&amp;debugEvent, INFINITE);</span><br><span class="line">		<span class="keyword">if</span>(!bRet)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;WaitForDebugEvent error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span>(debugEvent.dwDebugEventCode)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="comment">//1.异常</span></span><br><span class="line">		<span class="keyword">case</span> EXCEPTION_DEBUG_EVENT:</span><br><span class="line">			bRet = ExceptionHandler(&amp;debugEvent);</span><br><span class="line">			<span class="keyword">if</span>(!bRet)</span><br><span class="line">				dwContinue = DBG_EXCEPTION_NOT_HANDLED;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//2.</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//3.创建进程</span></span><br><span class="line">		<span class="keyword">case</span> CREATE_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="comment">//设置INT 3断点</span></span><br><span class="line">			SetInt3BreakPoint((PCHAR)debugEvent.u.CreateProcessInfo.lpStartAddress);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//4.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_THREAD_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//5.</span></span><br><span class="line">		<span class="keyword">case</span> EXIT_PROCESS_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//6.</span></span><br><span class="line">		<span class="keyword">case</span> LOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//7.</span></span><br><span class="line">		<span class="keyword">case</span> UNLOAD_DLL_DEBUG_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//8.</span></span><br><span class="line">		<span class="keyword">case</span> OUTPUT_DEBUG_STRING_EVENT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		bRet = ContinueDebugEvent(debugEvent.dwProcessId, debugEvent.dwThreadId, DBG_CONTINUE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2023/03/07/2023-3-WinKernel%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2023-03-12 00:00:00
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="Categories"></i>
                    
                    <span class="span--category">
                      <a href="/categories/Technology/" title="Technology">
                        <b>#</b> Technology
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Win32/" title="Win32">
                        #Win32
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2099/12/31/TOP/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#01-%E8%B0%83%E8%AF%95%E5%AF%B9%E8%B1%A1"><span class="toc-text">01.调试对象</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8%E4%B8%8E%E8%A2%AB%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F"><span class="toc-text">调试器与被调试程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DebugActiveProcess"><span class="toc-text">DebugActiveProcess</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel32-DebugActiveProcess"><span class="toc-text">kernel32!DebugActiveProcess</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#02-%E8%B0%83%E8%AF%95%E4%BA%8B%E4%BB%B6%E7%9A%84%E9%87%87%E9%9B%86"><span class="toc-text">02.调试事件的采集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%A7%8D%E7%B1%BB"><span class="toc-text">调试事件的种类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E4%BA%8B%E4%BB%B6%E9%87%87%E9%9B%86%E5%87%BD%E6%95%B0"><span class="toc-text">调试事件采集函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PspUserThreadStartup"><span class="toc-text">PspUserThreadStartup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PspExitThread"><span class="toc-text">PspExitThread</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#03-%E8%B0%83%E8%AF%95%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-text">03.调试事件的处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E6%98%93%E8%B0%83%E8%AF%95%E5%99%A8"><span class="toc-text">简易调试器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%9D%A5%E6%BA%90"><span class="toc-text">异常来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E6%98%93%E8%B0%83%E8%AF%95%E5%99%A8%EF%BC%9A%E9%99%84%E5%8A%A0"><span class="toc-text">简易调试器：附加</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#04-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">04.异常处理流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8%E4%B8%8E%E5%BC%82%E5%B8%B8%E5%85%B3%E7%B3%BB"><span class="toc-text">调试器与异常关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AA%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8"><span class="toc-text">未处理异常</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%90%86%E8%A7%A3UnhandledExceptionFilter%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">理解UnhandledExceptionFilter执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UnhandledExceptionFilter%E5%8F%8D%E8%B0%83%E8%AF%95"><span class="toc-text">UnhandledExceptionFilter反调试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#05-%E8%BD%AF%E4%BB%B6%E6%96%AD%E7%82%B9"><span class="toc-text">05.软件断点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E6%96%AD%E7%82%B9"><span class="toc-text">软件断点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E6%96%AD%E7%82%B9%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">软件断点执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A2%AB%E8%B0%83%E8%AF%95%E8%BF%9B%E7%A8%8B"><span class="toc-text">被调试进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8%E8%BF%9B%E7%A8%8B"><span class="toc-text">调试器进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-text">流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E8%BD%AF%E4%BB%B6%E6%96%AD%E7%82%B9"><span class="toc-text">处理软件断点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#06-%E5%86%85%E5%AD%98%E6%96%AD%E7%82%B9"><span class="toc-text">06.内存断点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%96%AD%E7%82%B9%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">内存断点执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A2%AB%E8%B0%83%E8%AF%95%E8%BF%9B%E7%A8%8B-1"><span class="toc-text">被调试进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8%E8%BF%9B%E7%A8%8B-1"><span class="toc-text">调试器进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%86%85%E5%AD%98%E6%96%AD%E7%82%B9"><span class="toc-text">处理内存断点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#07-%E7%A1%AC%E4%BB%B6%E6%96%AD%E7%82%B9"><span class="toc-text">07.硬件断点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E6%96%AD%E7%82%B9"><span class="toc-text">硬件断点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#08-%E5%8D%95%E6%AD%A5%E5%BC%82%E5%B8%B8"><span class="toc-text">08.单步异常</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#09-%E5%8D%95%E6%AD%A5%E6%AD%A5%E8%BF%87"><span class="toc-text">09.单步步过</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/Ghostasky">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/ghostasky">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/Ghostasky">怕什么真理无穷，进一寸有进一寸的欢喜。</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2023 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + Windows%E5%86%85%E6%A0%B8(%E5%8D%81%E4%B8%80)%E2%80%94%E2%80%94%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95 + '&url=' + https%3A%2F%2Fghostasky.github.io%2F2023%2F03%2F12%2F2023-3-WinKernel%25E8%25B0%2583%25E8%25AF%2595%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://ghostasky.github.io/2023/03/12/2023-3-WinKernel%E8%B0%83%E8%AF%95/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
