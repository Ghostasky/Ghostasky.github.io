<!DOCTYPE html>
<html lang="zh-cn" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="郁涛丶" />
  <meta name="description" content="" />
  
  
  <title>
    
      Windows内核(三)——系统调用 
      
      
      |
    
     郁涛丶&#39;s Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  
    
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 5.4.2"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Ghostasky</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Windows内核(三)——系统调用</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2023-01-16	  
        </span>
    <span class="post-pubtime"> 本文共4.5k字 </span>
    
    <span class="post-pubtime">大约需要32min </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="Categories"></i>
                
                <span class="span--category">
                  <a href="/categories/Technology/" title="Technology">
                    <b>#</b> Technology
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Win32/" title="Win32">
                    #Win32
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>[toc]</p>
<p>本文是windows内核系列的第三部分，本来应该是放到第二部分后面的，但是第二部分会用到这部分的相关内容 ，就先放第三部分了。</p>
<h1 id="001-API函数的调用过程-3环部分"><a href="#001-API函数的调用过程-3环部分" class="headerlink" title="001.API函数的调用过程(3环部分)"></a>001.API函数的调用过程(3环部分)</h1><p>主要是存放在 C:\WINDOWS\system32 下面所有的dll</p>
<p>几个重要的DLL</p>
<ul>
<li>Kernel32.dll:最核心的功能模块，比如管理内存、进程和线程相关的函数等.</li>
<li>User32.dll:是Windows用户界面相关应用程序接口,如创建窗口和发送消息等.</li>
<li>GDI32.dll:全称是Graphical Device Interface(图形设备接口),包含用于画图和显示文本的函数.比如要显示一个程序窗口，就调用了其中的函数来画这个窗口.</li>
<li>Ntdll.dll:大多数API都会通过这个DLL进入内核(0环).</li>
</ul>
<p>alt+t直接搜就行，这里使用<code>ReadProcesMemory</code>来举例</p>
<p>首先是kernel32这个dll</p>
<p>可以看到是call了一个函数，之后巴拉巴拉，</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230106134646722.png" alt="image-20230106134646722"></p>
<p>调用的这个函数在ntdll这个dll里面，在import可以看到，他做了这些事：其中的<code>0BA</code>是一个编号，<code>7FFE0300</code>决定以什么方式进0环</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230106134533807.png" alt="image-20230106134533807"></p>
<blockquote>
<p>kernel32.dll(ReadProcessMemory) =&gt;</p>
<p>ntdll.dll(NtReadVirtualMemory)</p>
</blockquote>
<h1 id="002-API函数的调用过程-3环进0环-上"><a href="#002-API函数的调用过程-3环进0环-上" class="headerlink" title="002.API函数的调用过程(3环进0环 上)"></a>002.API函数的调用过程(3环进0环 上)</h1><p>下面说下这部分：</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230106134533807.png" alt="image-20230106134533807"></p>
<p>首先是<code>7FFE0300</code>这个地址</p>
<h2 id="KUSER-SHARED-DATA"><a href="#KUSER-SHARED-DATA" class="headerlink" title="_KUSER_SHARED_DATA"></a>_KUSER_SHARED_DATA</h2><ol>
<li>在 User 层和 Kernel 层分别定义了一个 <code>_KUSER_SHARED_DATA</code> 结构区域，用于 User 层和 Kernel 层共享某些数据</li>
<li>它们使用固定的地址值映射，<code>_KUSER_SHARED_DATA</code> 结构区域在 User 和 Kernel 层地址分别为：<ul>
<li>User 层地址为：0x7ffe0000</li>
<li>Kernnel 层地址为：0xffdf0000</li>
</ul>
</li>
</ol>
<p>特别说明：</p>
<p>虽然指向的是同一个物理页，但在User 层是只读的，在Kernnel层是可写的.</p>
<p>可以看到两者都是一样的：</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230106140227852.png" alt="image-20230106140227852"></p>
<p>可以看到300的位置是系统调用：</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230106140509018.png" alt="image-20230106140509018"></p>
<h2 id="CPU是否支持快速调用"><a href="#CPU是否支持快速调用" class="headerlink" title="CPU是否支持快速调用"></a>CPU是否支持快速调用</h2><p>实验：是否支持快速调用</p>
<p>当通过<code>eax=1</code>来执行<code>cpuid</code>指令时，处理器的特征信息被放在<code>ecx</code>和<code>edx</code>寄存器中，其中<code>edx</code>包含了一个<code>SEP</code>位（11位），该位指明了当前处理器知否支持<code>sysenter/sysexit</code>指令</p>
<ul>
<li>支持：ntdll.dll!KiFastSystemCall()</li>
<li>不支持：ntdll.dll!KiIntSystemCall()</li>
</ul>
<p>eax置1后执行，发现是0xBFF，第11位是1，表示支持</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230106141108580.png" alt="image-20230106141108580"></p>
<p>当系统启动的时候，上述执行，之后将相应的函数放到偏移0x300的位置。</p>
<h2 id="进R0需要更改哪些寄存器"><a href="#进R0需要更改哪些寄存器" class="headerlink" title="进R0需要更改哪些寄存器"></a>进R0需要更改哪些寄存器</h2><ol>
<li><p>CS的权限由3变为0，意味着需要新的CS</p>
</li>
<li><p>SS与CS的权限永远一致，需要新的SS</p>
</li>
<li><p>权限发生切换的时候，堆栈也一定会切换，需要新的ESP</p>
</li>
<li><p>进0环后代码的位置，需要EIP</p>
</li>
</ol>
<hr>
<p>不支持的时候使用的是<code>ntdll.dll!KiIntSystemCall()</code></p>
<p>将eax中的编号和edx(参数指针)，之后中断<code>0x2E</code>进入内核</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230106142000444.png" alt="image-20230106142000444"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kd&gt;  dq 8003f400+170</span><br><span class="line">ReadVirtual: 8003f570 not properly sign extended</span><br><span class="line">8003f570  8054ee00`00082611 80548e00`0008590c</span><br><span class="line">8003f580  80548e00`00081cd0 80548e00`00081cda</span><br><span class="line">8003f590  80548e00`00081ce4 80548e00`00081cee</span><br><span class="line">8003f5a0  80548e00`00081cf8 80548e00`00081d02</span><br><span class="line">8003f5b0  80548e00`00081d0c 806e8e00`00087864</span><br><span class="line">8003f5c0  80548e00`00081d20 80548e00`00081d2a</span><br><span class="line">8003f5d0  80548e00`00081d34 80548e00`00081d3e</span><br><span class="line">8003f5e0  80548e00`00081d48 806e8e00`00088e2c</span><br><span class="line">kd&gt; u 80542611</span><br><span class="line">ReadVirtual: 80542611 not properly sign extended</span><br><span class="line">80542611 6a00            push    0</span><br><span class="line">80542613 55              push    ebp</span><br><span class="line">80542614 53              push    ebx</span><br><span class="line">80542615 56              push    esi</span><br><span class="line">80542616 57              push    edi</span><br><span class="line">80542617 0fa0            push    fs</span><br><span class="line">80542619 bb30000000      mov     ebx,30h</span><br><span class="line">8054261e 668ee3          mov     fs,bx</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>支持快速调用的时候使用<code>ntdll.dll!KiFastSystemCall()</code></p>
<p>也就2行代码：</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230106143004394.png" alt="image-20230106143004394"></p>
<p>中断门进0环，需要的CS、EIP在IDT表中，需要查内存(SS与ESP由TSS提供)而CPU如果支持sysenter指令时，操作系统会提前将CS/SS/ESP/EIP的值存储在MSR寄存器中，sysenter指令执行时，CPU会将MSR寄存器中的值直接写入相关寄存器，没有读内存的过程，所以叫快速调用，本质是一样的！</p>
<h1 id="003-API函数的调用过程-3环进0环-下"><a href="#003-API函数的调用过程-3环进0环-下" class="headerlink" title="003.API函数的调用过程(3环进0环 下)"></a>003.API函数的调用过程(3环进0环 下)</h1><p>不支持快速调用的话就中断进0环，支持的话就sysenter，需要的寄存器信息(CS，SS,ESP,EIP)在<code>MSR</code>寄存器中可以找到：(ss在cs+8的位置)</p>
<table>
<thead>
<tr>
<th><strong>MSR</strong></th>
<th><strong>地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td>IA32_SYSENTER_CS</td>
<td>174H</td>
</tr>
<tr>
<td>IA32_SYSENTER_ESP</td>
<td>175H</td>
</tr>
<tr>
<td>IA32_SYSENTER_EIP</td>
<td>176H</td>
</tr>
</tbody></table>
<p>可以通过RDMSR/WRMST来进行读写（操作系统使用WRMST写该寄存器）:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; rdmsr 174   //查看CS</span><br><span class="line">kd&gt; rdmsr 175   //查看ESP</span><br><span class="line">kd&gt; rdmsr 176   //查看EIP</span><br><span class="line">&gt; 参考：Intel白皮书第二卷(搜索sysenter)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; rdmsr 174</span><br><span class="line">msr[174] = 00000000`00000008</span><br><span class="line">kd&gt; rdmsr 175</span><br><span class="line">msr[175] = 00000000`f78af000</span><br><span class="line">kd&gt; rdmsr 176</span><br><span class="line">msr[176] = 00000000`805426e0</span><br><span class="line">kd&gt; u 805426e0</span><br><span class="line">ReadVirtual: 805426e0 not properly sign extended</span><br><span class="line">805426e0 b923000000      mov     ecx,23h</span><br><span class="line">805426e5 6a30            push    30h</span><br><span class="line">805426e7 0fa1            pop     fs</span><br><span class="line">805426e9 8ed9            mov     ds,cx</span><br><span class="line">805426eb 8ec1            mov     es,cx</span><br><span class="line">805426ed 648b0d40000000  mov     ecx,dword ptr fs:[40h]</span><br><span class="line">805426f4 8b6104          mov     esp,dword ptr [ecx+4]</span><br><span class="line">805426f7 6a23            push    23h</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>API通过中断门进0环：</p>
<pre><code>1)  固定中断号为0x2E
2)  CS/EIP由门描述符提供   ESP/SS由TSS提供
3)  进入0环后执行的内核函数：NT!KiSystemService
</code></pre>
<p>API通过sysenter指令进0环：</p>
<pre><code>1)  CS/ESP/EIP由MSR寄存器提供(SS是算出来的)
2)  进入0环后执行的内核函数：NT!KiFastCallEntry
</code></pre>
<p>内核模块：<code>ntoskrnl.exe/ntkrnlpa.exe</code></p>
<h1 id="004-API函数的调用过程-保存现场"><a href="#004-API函数的调用过程-保存现场" class="headerlink" title="004.API函数的调用过程(保存现场)"></a>004.API函数的调用过程(保存现场)</h1><p>这里使用<code>KiSystemService</code>举例。</p>
<p>首先接收三个结构体：</p>
<h2 id="Trap-Frame结构体"><a href="#Trap-Frame结构体" class="headerlink" title="_Trap_Frame结构体"></a>_Trap_Frame结构体</h2><p>这个结构体在0环，由操作系统进行维护</p>
<p><strong>无论是快速调用还是中断进0环都会将寄存器写到这个结构体里</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _ktrap_Frame</span><br></pre></td></tr></table></figure>

<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230107134858939.png"></p>
<p>在中断进入0环的时候，会压入<code>0x068~0x078</code>的5个值，快速调用的 时候，这5个值是没有的。</p>
<h2 id="ETHREAD线程相关的结构体"><a href="#ETHREAD线程相关的结构体" class="headerlink" title="_ETHREAD线程相关的结构体"></a>_ETHREAD线程相关的结构体</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _ETHREAD</span><br><span class="line">ntdll!_ETHREAD</span><br><span class="line">   +0x000 Tcb              : _KTHREAD</span><br><span class="line">   +0x1c0 CreateTime       : _LARGE_INTEGER</span><br><span class="line">   +0x1c0 NestedFaultCount : Pos 0, 2 Bits</span><br><span class="line">   +0x1c0 ApcNeeded        : Pos 2, 1 Bit</span><br><span class="line">   +0x1c8 ExitTime         : _LARGE_INTEGER</span><br><span class="line">   +0x1c8 LpcReplyChain    : _LIST_ENTRY</span><br><span class="line">   +0x1c8 KeyedWaitChain   : _LIST_ENTRY</span><br><span class="line">   +0x1d0 ExitStatus       : Int4B</span><br><span class="line">   +0x1d0 OfsChain         : Ptr32 Void</span><br><span class="line">   +0x1d4 PostBlockList    : _LIST_ENTRY</span><br><span class="line">   +0x1dc TerminationPort  : Ptr32 _TERMINATION_PORT</span><br><span class="line">   +0x1dc ReaperLink       : Ptr32 _ETHREAD</span><br><span class="line">   +0x1dc KeyedWaitValue   : Ptr32 Void</span><br><span class="line">   +0x1e0 ActiveTimerListLock : Uint4B</span><br><span class="line">   +0x1e4 ActiveTimerListHead : _LIST_ENTRY</span><br><span class="line">   +0x1ec Cid              : _CLIENT_ID</span><br><span class="line">   +0x1f4 LpcReplySemaphore : _KSEMAPHORE</span><br><span class="line">   +0x1f4 KeyedWaitSemaphore : _KSEMAPHORE</span><br><span class="line">   +0x208 LpcReplyMessage  : Ptr32 Void</span><br><span class="line">   +0x208 LpcWaitingOnPort : Ptr32 Void</span><br><span class="line">   +0x20c ImpersonationInfo : Ptr32 _PS_IMPERSONATION_INFORMATION</span><br><span class="line">   +0x210 IrpList          : _LIST_ENTRY</span><br><span class="line">   +0x218 TopLevelIrp      : Uint4B</span><br><span class="line">   +0x21c DeviceToVerify   : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +0x220 ThreadsProcess   : Ptr32 _EPROCESS</span><br><span class="line">   +0x224 StartAddress     : Ptr32 Void</span><br><span class="line">   +0x228 Win32StartAddress : Ptr32 Void</span><br><span class="line">   +0x228 LpcReceivedMessageId : Uint4B</span><br><span class="line">   +0x22c ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +0x234 RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   +0x238 ThreadLock       : _EX_PUSH_LOCK</span><br><span class="line">   +0x23c LpcReplyMessageId : Uint4B</span><br><span class="line">   +0x240 ReadClusterSize  : Uint4B</span><br><span class="line">   +0x244 GrantedAccess    : Uint4B</span><br><span class="line">   +0x248 CrossThreadFlags : Uint4B</span><br><span class="line">   +0x248 Terminated       : Pos 0, 1 Bit</span><br><span class="line">   +0x248 DeadThread       : Pos 1, 1 Bit</span><br><span class="line">   +0x248 HideFromDebugger : Pos 2, 1 Bit</span><br><span class="line">   +0x248 ActiveImpersonationInfo : Pos 3, 1 Bit</span><br><span class="line">   +0x248 SystemThread     : Pos 4, 1 Bit</span><br><span class="line">   +0x248 HardErrorsAreDisabled : Pos 5, 1 Bit</span><br><span class="line">   +0x248 BreakOnTermination : Pos 6, 1 Bit</span><br><span class="line">   +0x248 SkipCreationMsg  : Pos 7, 1 Bit</span><br><span class="line">   +0x248 SkipTerminationMsg : Pos 8, 1 Bit</span><br><span class="line">   +0x24c SameThreadPassiveFlags : Uint4B</span><br><span class="line">   +0x24c ActiveExWorker   : Pos 0, 1 Bit</span><br><span class="line">   +0x24c ExWorkerCanWaitUser : Pos 1, 1 Bit</span><br><span class="line">   +0x24c MemoryMaker      : Pos 2, 1 Bit</span><br><span class="line">   +0x250 SameThreadApcFlags : Uint4B</span><br><span class="line">   +0x250 LpcReceivedMsgIdValid : Pos 0, 1 Bit</span><br><span class="line">   +0x250 LpcExitThreadCalled : Pos 1, 1 Bit</span><br><span class="line">   +0x250 AddressSpaceOwner : Pos 2, 1 Bit</span><br><span class="line">   +0x254 ForwardClusterOnly : UChar</span><br><span class="line">   +0x255 DisablePageFaultClustering : UChar</span><br></pre></td></tr></table></figure>

<p>里面有个<code>_KTHREAD</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KTHREAD</span><br><span class="line">ntdll!_KTHREAD</span><br><span class="line">   +0x000 Header           : _DISPATCHER_HEADER</span><br><span class="line">   +0x010 MutantListHead   : _LIST_ENTRY</span><br><span class="line">   +0x018 InitialStack     : Ptr32 Void</span><br><span class="line">   +0x01c StackLimit       : Ptr32 Void</span><br><span class="line">   +0x020 Teb              : Ptr32 Void</span><br><span class="line">   +0x024 TlsArray         : Ptr32 Void</span><br><span class="line">   +0x028 KernelStack      : Ptr32 Void</span><br><span class="line">   +0x02c DebugActive      : UChar</span><br><span class="line">   +0x02d State            : UChar</span><br><span class="line">   +0x02e Alerted          : [2] UChar</span><br><span class="line">   +0x030 Iopl             : UChar</span><br><span class="line">   +0x031 NpxState         : UChar</span><br><span class="line">   +0x032 Saturation       : Char</span><br><span class="line">   +0x033 Priority         : Char</span><br><span class="line">   +0x034 ApcState         : _KAPC_STATE</span><br><span class="line">   +0x04c ContextSwitches  : Uint4B</span><br><span class="line">   +0x050 IdleSwapBlock    : UChar</span><br><span class="line">   +0x051 Spare0           : [3] UChar</span><br><span class="line">   +0x054 WaitStatus       : Int4B</span><br><span class="line">   +0x058 WaitIrql         : UChar</span><br><span class="line">   +0x059 WaitMode         : Char</span><br><span class="line">   +0x05a WaitNext         : UChar</span><br><span class="line">   +0x05b WaitReason       : UChar</span><br><span class="line">   +0x05c WaitBlockList    : Ptr32 _KWAIT_BLOCK</span><br><span class="line">   +0x060 WaitListEntry    : _LIST_ENTRY</span><br><span class="line">   +0x060 SwapListEntry    : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x068 WaitTime         : Uint4B</span><br><span class="line">   +0x06c BasePriority     : Char</span><br><span class="line">   +0x06d DecrementCount   : UChar</span><br><span class="line">   +0x06e PriorityDecrement : Char</span><br><span class="line">   +0x06f Quantum          : Char</span><br><span class="line">   +0x070 WaitBlock        : [4] _KWAIT_BLOCK</span><br><span class="line">   +0x0d0 LegoData         : Ptr32 Void</span><br><span class="line">   +0x0d4 KernelApcDisable : Uint4B</span><br><span class="line">   +0x0d8 UserAffinity     : Uint4B</span><br><span class="line">   +0x0dc SystemAffinityActive : UChar</span><br><span class="line">   +0x0dd PowerState       : UChar</span><br><span class="line">   +0x0de NpxIrql          : UChar</span><br><span class="line">   +0x0df InitialNode      : UChar</span><br><span class="line">   +0x0e0 ServiceTable     : Ptr32 Void</span><br><span class="line">   +0x0e4 Queue            : Ptr32 _KQUEUE</span><br><span class="line">   +0x0e8 ApcQueueLock     : Uint4B</span><br><span class="line">   +0x0f0 Timer            : _KTIMER</span><br><span class="line">   +0x118 QueueListEntry   : _LIST_ENTRY</span><br><span class="line">   +0x120 SoftAffinity     : Uint4B</span><br><span class="line">   +0x124 Affinity         : Uint4B</span><br><span class="line">   +0x128 Preempted        : UChar</span><br><span class="line">   +0x129 ProcessReadyQueue : UChar</span><br><span class="line">   +0x12a KernelStackResident : UChar</span><br><span class="line">   +0x12b NextProcessor    : UChar</span><br><span class="line">   +0x12c CallbackStack    : Ptr32 Void</span><br><span class="line">   +0x130 Win32Thread      : Ptr32 Void</span><br><span class="line">   +0x134 TrapFrame        : Ptr32 _KTRAP_FRAME</span><br><span class="line">   +0x138 ApcStatePointer  : [2] Ptr32 _KAPC_STATE</span><br><span class="line">   +0x140 PreviousMode     : Char</span><br><span class="line">   +0x141 EnableStackSwap  : UChar</span><br><span class="line">   +0x142 LargeStack       : UChar</span><br><span class="line">   +0x143 ResourceIndex    : UChar</span><br><span class="line">   +0x144 KernelTime       : Uint4B</span><br><span class="line">   +0x148 UserTime         : Uint4B</span><br><span class="line">   +0x14c SavedApcState    : _KAPC_STATE</span><br><span class="line">   +0x164 Alertable        : UChar</span><br><span class="line">   +0x165 ApcStateIndex    : UChar</span><br><span class="line">   +0x166 ApcQueueable     : UChar</span><br><span class="line">   +0x167 AutoAlignment    : UChar</span><br><span class="line">   +0x168 StackBase        : Ptr32 Void</span><br><span class="line">   +0x16c SuspendApc       : _KAPC</span><br><span class="line">   +0x19c SuspendSemaphore : _KSEMAPHORE</span><br><span class="line">   +0x1b0 ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +0x1b8 FreezeCount      : Char</span><br><span class="line">   +0x1b9 SuspendCount     : Char</span><br><span class="line">   +0x1ba IdealProcessor   : UChar</span><br><span class="line">   +0x1bb DisableBoost     : UChar</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="KPCR"><a href="#KPCR" class="headerlink" title="_KPCR"></a>_KPCR</h2><p>KPCR  叫CPU控制区（Processor Control Region）</p>
<p>CPU也有自己的控制块，每一个CPU有一个，叫KPCR</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPCR</span><br><span class="line">nt!_KPCR</span><br><span class="line">   +0x000 NtTib            : _NT_TIB</span><br><span class="line">   +0x01c SelfPcr          : Ptr32 _KPCR</span><br><span class="line">   +0x020 Prcb             : Ptr32 _KPRCB</span><br><span class="line">   +0x024 Irql             : UChar</span><br><span class="line">   +0x028 IRR              : Uint4B</span><br><span class="line">   +0x02c IrrActive        : Uint4B</span><br><span class="line">   +0x030 IDR              : Uint4B</span><br><span class="line">   +0x034 KdVersionBlock   : Ptr32 Void</span><br><span class="line">   +0x038 IDT              : Ptr32 _KIDTENTRY</span><br><span class="line">   +0x03c GDT              : Ptr32 _KGDTENTRY</span><br><span class="line">   +0x040 TSS              : Ptr32 _KTSS</span><br><span class="line">   +0x044 MajorVersion     : Uint2B</span><br><span class="line">   +0x046 MinorVersion     : Uint2B</span><br><span class="line">   +0x048 SetMember        : Uint4B</span><br><span class="line">   +0x04c StallScaleFactor : Uint4B</span><br><span class="line">   +0x050 DebugActive      : UChar</span><br><span class="line">   +0x051 Number           : UChar</span><br><span class="line">   +0x052 Spare0           : UChar</span><br><span class="line">   +0x053 SecondLevelCacheAssociativity : UChar</span><br><span class="line">   +0x054 VdmAlert         : Uint4B</span><br><span class="line">   +0x058 KernelReserved   : [14] Uint4B</span><br><span class="line">   +0x090 SecondLevelCacheSize : Uint4B</span><br><span class="line">   +0x094 HalReserved      : [16] Uint4B</span><br><span class="line">   +0x0d4 InterruptMode    : Uint4B</span><br><span class="line">   +0x0d8 Spare1           : UChar</span><br><span class="line">   +0x0dc KernelReserved2  : [17] Uint4B</span><br><span class="line">   +0x120 PrcbData         : _KPRCB</span><br></pre></td></tr></table></figure>

<p>其中第一个是一个结构体<code>_NT_TIB</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _NT_TIB</span><br><span class="line">ntdll!_NT_TIB</span><br><span class="line">   +0x000 ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD</span><br><span class="line">   +0x004 StackBase        : Ptr32 Void</span><br><span class="line">   +0x008 StackLimit       : Ptr32 Void</span><br><span class="line">   +0x00c SubSystemTib     : Ptr32 Void</span><br><span class="line">   +0x010 FiberData        : Ptr32 Void</span><br><span class="line">   +0x010 Version          : Uint4B</span><br><span class="line">   +0x014 ArbitraryUserPointer : Ptr32 Void</span><br><span class="line">   +0x018 Self             : Ptr32 _NT_TIB//结构体指针 指向自己</span><br></pre></td></tr></table></figure>

<p><code>_KPRC</code>的最后一个也是一个结构体<code>_KPRCB</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPRCB</span><br><span class="line">ntdll!_KPRCB</span><br><span class="line">   +0x000 MinorVersion     : Uint2B</span><br><span class="line">   +0x002 MajorVersion     : Uint2B</span><br><span class="line">   +0x004 CurrentThread    : Ptr32 _KTHREAD//当前CPU所执行线程的_ETHREAD</span><br><span class="line">   +0x008 NextThread       : Ptr32 _KTHREAD//下一个_ETHREAD</span><br><span class="line">   +0x00c IdleThread       : Ptr32 _KTHREAD//当所以线程都执行完了CPU就可以执行这个</span><br><span class="line">   +0x010 Number           : Char//CPU编号</span><br><span class="line">   +0x011 Reserved         : Char</span><br><span class="line">   +0x012 BuildType        : Uint2B</span><br><span class="line">   +0x014 SetMember        : Uint4B</span><br><span class="line">   +0x018 CpuType          : Char</span><br><span class="line">   +0x019 CpuID            : Char</span><br><span class="line">   +0x01a CpuStep          : Uint2B//CPU子版本号</span><br><span class="line">   +0x01c ProcessorState   : _KPROCESSOR_STATE//CPU状态</span><br><span class="line">   +0x33c KernelReserved   : [16] Uint4B</span><br><span class="line">   +0x37c HalReserved      : [16] Uint4B</span><br><span class="line">   +0x3bc PrcbPad0         : [92] UChar</span><br><span class="line">   +0x418 LockQueue        : [16] _KSPIN_LOCK_QUEUE</span><br><span class="line">   +0x498 PrcbPad1         : [8] UChar</span><br><span class="line">   +0x4a0 NpxThread        : Ptr32 _KTHREAD//Npx浮点处理器  最后一次用过浮点的线程</span><br><span class="line">   +0x4a4 InterruptCount   : Uint4B//中断计数 统计信息 没什么实际意义 自己调试用的</span><br><span class="line">   +0x4a8 KernelTime       : Uint4B//统计信息</span><br><span class="line">   +0x4ac UserTime         : Uint4B//统计信息</span><br><span class="line">   +0x4b0 DpcTime          : Uint4B//统计信息</span><br><span class="line">   +0x4b4 DebugDpcTime     : Uint4B//统计信息</span><br><span class="line">   +0x4b8 InterruptTime    : Uint4B//统计信息</span><br><span class="line">   +0x4bc AdjustDpcThreshold : Uint4B</span><br><span class="line">   +0x4c0 PageColor        : Uint4B</span><br><span class="line">   +0x4c4 SkipTick         : Uint4B</span><br><span class="line">   +0x4c8 MultiThreadSetBusy : UChar</span><br><span class="line">   +0x4c9 Spare2           : [3] UChar</span><br><span class="line">   +0x4cc ParentNode       : Ptr32 _KNODE</span><br><span class="line">   +0x4d0 MultiThreadProcessorSet : Uint4B</span><br><span class="line">   +0x4d4 MultiThreadSetMaster : Ptr32 _KPRCB</span><br><span class="line">   +0x4d8 ThreadStartCount : [2] Uint4B</span><br><span class="line">   +0x4e0 CcFastReadNoWait : Uint4B</span><br><span class="line">   +0x4e4 CcFastReadWait   : Uint4B</span><br><span class="line">   +0x4e8 CcFastReadNotPossible : Uint4B</span><br><span class="line">   +0x4ec CcCopyReadNoWait : Uint4B</span><br><span class="line">   +0x4f0 CcCopyReadWait   : Uint4B</span><br><span class="line">   +0x4f4 CcCopyReadNoWaitMiss : Uint4B</span><br><span class="line">   +0x4f8 KeAlignmentFixupCount : Uint4B</span><br><span class="line">   +0x4fc KeContextSwitches : Uint4B</span><br><span class="line">   +0x500 KeDcacheFlushCount : Uint4B</span><br><span class="line">   +0x504 KeExceptionDispatchCount : Uint4B</span><br><span class="line">   +0x508 KeFirstLevelTbFills : Uint4B</span><br><span class="line">   +0x50c KeFloatingEmulationCount : Uint4B</span><br><span class="line">   +0x510 KeIcacheFlushCount : Uint4B</span><br><span class="line">   +0x514 KeSecondLevelTbFills : Uint4B</span><br><span class="line">   +0x518 KeSystemCalls    : Uint4B</span><br><span class="line">   +0x51c SpareCounter0    : [1] Uint4B</span><br><span class="line">   +0x520 PPLookasideList  : [16] _PP_LOOKASIDE_LIST</span><br><span class="line">   +0x5a0 PPNPagedLookasideList : [32] _PP_LOOKASIDE_LIST</span><br><span class="line">   +0x6a0 PPPagedLookasideList : [32] _PP_LOOKASIDE_LIST</span><br><span class="line">   +0x7a0 PacketBarrier    : Uint4B</span><br><span class="line">   +0x7a4 ReverseStall     : Uint4B</span><br><span class="line">   +0x7a8 IpiFrame         : Ptr32 Void</span><br><span class="line">   +0x7ac PrcbPad2         : [52] UChar</span><br><span class="line">   +0x7e0 CurrentPacket    : [3] Ptr32 Void</span><br><span class="line">   +0x7ec TargetSet        : Uint4B</span><br><span class="line">   +0x7f0 WorkerRoutine    : Ptr32     void </span><br><span class="line">   +0x7f4 IpiFrozen        : Uint4B</span><br><span class="line">   +0x7f8 PrcbPad3         : [40] UChar</span><br><span class="line">   +0x820 RequestSummary   : Uint4B</span><br><span class="line">   +0x824 SignalDone       : Ptr32 _KPRCB</span><br><span class="line">   +0x828 PrcbPad4         : [56] UChar</span><br><span class="line">   +0x860 DpcListHead      : _LIST_ENTRY</span><br><span class="line">   +0x868 DpcStack         : Ptr32 Void</span><br><span class="line">   +0x86c DpcCount         : Uint4B</span><br><span class="line">   +0x870 DpcQueueDepth    : Uint4B</span><br><span class="line">   +0x874 DpcRoutineActive : Uint4B</span><br><span class="line">   +0x878 DpcInterruptRequested : Uint4B</span><br><span class="line">   +0x87c DpcLastCount     : Uint4B</span><br><span class="line">   +0x880 DpcRequestRate   : Uint4B</span><br><span class="line">   +0x884 MaximumDpcQueueDepth : Uint4B</span><br><span class="line">   +0x888 MinimumDpcRate   : Uint4B</span><br><span class="line">   +0x88c QuantumEnd       : Uint4B</span><br><span class="line">   +0x890 PrcbPad5         : [16] UChar</span><br><span class="line">   +0x8a0 DpcLock          : Uint4B</span><br><span class="line">   +0x8a4 PrcbPad6         : [28] UChar</span><br><span class="line">   +0x8c0 CallDpc          : _KDPC</span><br><span class="line">   +0x8e0 ChainedInterruptList : Ptr32 Void</span><br><span class="line">   +0x8e4 LookasideIrpFloat : Int4B</span><br><span class="line">   +0x8e8 SpareFields0     : [6] Uint4B</span><br><span class="line">   +0x900 VendorString     : [13] UChar</span><br><span class="line">   +0x90d InitialApicId    : UChar</span><br><span class="line">   +0x90e LogicalProcessorsPerPhysicalProcessor : UChar//每个物理处理器有几个逻辑处理器</span><br><span class="line">   +0x910 MHz              : Uint4B//频率 </span><br><span class="line">   +0x914 FeatureBits      : Uint4B</span><br><span class="line">   +0x918 UpdateSignature  : _LARGE_INTEGER</span><br><span class="line">   +0x920 NpxSaveArea      : _FX_SAVE_AREA</span><br><span class="line">   +0xb30 PowerState       : _PROCESSOR_POWER_STATE</span><br></pre></td></tr></table></figure>



<h2 id="逆向分析-KiSystemService"><a href="#逆向分析-KiSystemService" class="headerlink" title="逆向分析 KiSystemService"></a>逆向分析 KiSystemService</h2><p><code>KiSystemService</code>这个函数也就是中断的时候，<code>0x2E</code>的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">.text:004067D1 _KiSystemService proc near              ; CODE XREF: ZwAcceptConnectPort(x,x,x,x,x,x)+C↓p</span><br><span class="line">.text:004067D1                                         ; ZwAccessCheck(x,x,x,x,x,x,x,x)+C↓p ...</span><br><span class="line">.text:004067D1</span><br><span class="line">.text:004067D1 arg_0           = dword ptr  4</span><br><span class="line">.text:004067D1</span><br><span class="line">.text:004067D1                 push    0</span><br><span class="line">.text:004067D3                 push    ebp             ; push的0是压入0x064 ErrCode的位置</span><br><span class="line">.text:004067D4                 push    ebx             ; +0x05c Ebx</span><br><span class="line">.text:004067D5                 push    esi             ; +0x058 Esi</span><br><span class="line">.text:004067D6                 push    edi             ; +0x054 Edi</span><br><span class="line">.text:004067D7                 push    fs              ; +0x050 SegFs</span><br><span class="line">.text:004067D9                 mov     ebx, 30h ; &#x27;0&#x27;  ; 为FS寄存器赋值，指向KPCR结构体</span><br><span class="line">.text:004067DE                 mov     fs, ebx         ; 将段选择子0x30查询GDT这张表，找到对应的段描述符，把段描述符加载到FS寄存器</span><br><span class="line">.text:004067DE                                         ;</span><br><span class="line">.text:004067DE                                         ; 0x30: // 0011 0000</span><br><span class="line">.text:004067DE                                         ; 索引为6的段描述符，查GDT表</span><br><span class="line">.text:004067DE                                         ; 本机中idx为6的值：ffc093df`f0000001</span><br><span class="line">.text:004067DE                                         ; fs.base = ffdff000，指向当前CPU的KPCR结构</span><br><span class="line">.text:004067E0                 push    large dword ptr fs:0 ; 保存旧的 ExceptionList，然后把新的清成-1</span><br><span class="line">.text:004067E7                 mov     large dword ptr fs:0, 0FFFFFFFFh</span><br><span class="line">.text:004067F2                 mov     esi, large fs:124h ; esi 指向 CurrentThread，当前CPU所执行线程的_ETHREAD</span><br><span class="line">.text:004067F9                 push    dword ptr [esi+140h] ; 保存 CurrentThread.PreviousMode(先前模式)</span><br><span class="line">.text:004067F9                                         ; PreviousMode = 0 表示从0环调用过来</span><br><span class="line">.text:004067F9                                         ; PreviousMode = 1 表示从3环调用过来</span><br><span class="line">.text:004067FF                 sub     esp, 48h        ; esp 指向 _KTRAP_FRAME</span><br><span class="line">.text:00406802                 mov     ebx, [esp+68h+arg_0] ; 取出esp+0x6C,也就是3环压入的参数CS</span><br><span class="line">.text:00406806                 and     ebx, 1          ; 0环最低位为0,3环最低位为1</span><br><span class="line">.text:00406809                 mov     [esi+140h], bl  ; 填写新的“先前模式”</span><br><span class="line">.text:0040680F                 mov     ebp, esp        ; ESP == EBP ==_KTRAP_FRAME</span><br><span class="line">.text:00406811                 mov     ebx, [esi+134h] ; EBX现在是_KTRAP_FRAME</span><br><span class="line">.text:00406817                 mov     [ebp+3Ch], ebx  ; 将_KTRAP_FRAME中的TrapFrame暂时存到这里，之后</span><br><span class="line">.text:00406817                                         ; mov     edx, [ebp+3Ch]</span><br><span class="line">.text:00406817                                         ; 会将这个值取出来重新赋给_KTRAP_FRAME的TrapFrame</span><br><span class="line">.text:0040681A                 mov     [esi+134h], ebp ; CurrentThread.TrapFrame 指向当前 _KTRAP_FRAME</span><br><span class="line">.text:00406820                 cld                     ; 将标志寄存器Flag的方向标志位DF清零</span><br><span class="line">.text:00406821                 mov     ebx, [ebp+60h]  ;  3环ebp</span><br><span class="line">.text:00406824                 mov     edi, [ebp+68h]  ; 3环eip</span><br><span class="line">.text:00406827                 mov     [ebp+0Ch], edx  ; _KTRAP_FRAME.DbgArgPointer = edx</span><br><span class="line">.text:00406827                                         ; 这一步是保存3环API参数指针</span><br><span class="line">.text:0040682A                 mov     dword ptr [ebp+8], 0BADB0D00h</span><br><span class="line">.text:00406831                 mov     [ebp+0], ebx    ; _KTRAP_FRAME.DbgEbp = _KTRAP_FRAME.Ebp</span><br><span class="line">.text:00406834                 mov     [ebp+4], edi    ; _KTRAP_FRAME.DbgEip = _KTRAP_FRAME.Eip</span><br><span class="line">.text:00406837                 test    byte ptr [esi+2Ch], 0FFh</span><br><span class="line">.text:0040683B                 jnz     Dr_kss_a        ; 测试 CurrentThread.DebugActive</span><br><span class="line">.text:0040683B                                         ; 如果正被调试，保存调试相关的寄存器到 _KTRAP_FRAME</span><br><span class="line">.text:00406841</span><br><span class="line">.text:00406841 loc_406841:                             ; CODE XREF: Dr_kss_a+10↑j</span><br><span class="line">.text:00406841                                         ; Dr_kss_a+7C↑j</span><br><span class="line">.text:00406841                 sti                     ; 允许中断</span><br><span class="line">.text:00406842                 jmp     loc_406932</span><br><span class="line">.text:00406842 _KiSystemService endp</span><br></pre></td></tr></table></figure>

<h1 id="005-API函数的调用过程-系统服务表"><a href="#005-API函数的调用过程-系统服务表" class="headerlink" title="005.API函数的调用过程(系统服务表)"></a>005.API函数的调用过程(系统服务表)</h1><p>上节内容：进0环后，3环的各种寄存器都会保留到_Trap_Frame结构体中</p>
<p>本节内容：</p>
<ul>
<li>如何根据系统服务号(eax中存储)找到要执行的内核函数？</li>
<li>调用时参数是存储到3环的堆栈，如何传递给内核函数？</li>
</ul>
<p>SystemServiceTable 系统服务表</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230107230553238.png" alt="image-20230107230553238"></p>
<p>这个表在<code>_KTHREAD</code>的偏移为0xE0的位置。</p>
<p>如何判断是上面还是下面那张表：</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230107230710291.png" alt="image-20230107230710291"></p>
<p>这个是<code>_KiFastCallEntry</code>，KiSystemService的最后直接到了<code>0x00406932</code>的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">.text:0040689F _KiFastCallEntry proc near              ; DATA XREF: _KiTrap01+71↓o</span><br><span class="line">.text:0040689F                                         ; KiLoadFastSyscallMachineSpecificRegisters(x)+24↓o</span><br><span class="line">.text:0040689F</span><br><span class="line">.text:0040689F var_B           = byte ptr -0Bh</span><br><span class="line">.text:0040689F</span><br><span class="line">.text:0040689F ; FUNCTION CHUNK AT .text:0040686C SIZE 00000024 BYTES</span><br><span class="line">.text:0040689F</span><br><span class="line">.text:0040689F                 mov     ecx, 23h ; &#x27;#&#x27;</span><br><span class="line">.text:004068A4                 push    30h ; &#x27;0&#x27;</span><br><span class="line">.text:004068A6                 pop     fs</span><br><span class="line">.text:004068A8                 mov     ds, ecx</span><br><span class="line">.text:004068AA                 mov     es, ecx</span><br><span class="line">.text:004068AC                 mov     ecx, large fs:40h</span><br><span class="line">.text:004068B3                 mov     esp, [ecx+4]</span><br><span class="line">.text:004068B6                 push    23h ; &#x27;#&#x27;</span><br><span class="line">.text:004068B8                 push    edx</span><br><span class="line">.text:004068B9                 pushf</span><br><span class="line">.text:004068BA</span><br><span class="line">.text:004068BA loc_4068BA:                             ; CODE XREF: _KiFastCallEntry2+23↑j</span><br><span class="line">.text:004068BA                 push    2</span><br><span class="line">.text:004068BC                 add     edx, 8</span><br><span class="line">.text:004068BF                 popf</span><br><span class="line">.text:004068C0                 or      [esp+0Ch+var_B], 2</span><br><span class="line">.text:004068C5                 push    1Bh</span><br><span class="line">.text:004068C7                 push    dword ptr ds:0FFDF0304h</span><br><span class="line">.text:004068CD                 push    0</span><br><span class="line">.text:004068CF                 push    ebp</span><br><span class="line">.text:004068D0                 push    ebx</span><br><span class="line">.text:004068D1                 push    esi</span><br><span class="line">.text:004068D2                 push    edi</span><br><span class="line">.text:004068D3                 mov     ebx, large fs:1Ch</span><br><span class="line">.text:004068DA                 push    3Bh ; &#x27;;&#x27;</span><br><span class="line">.text:004068DC                 mov     esi, [ebx+124h]</span><br><span class="line">.text:004068E2                 push    dword ptr [ebx]</span><br><span class="line">.text:004068E4                 mov     dword ptr [ebx], 0FFFFFFFFh</span><br><span class="line">.text:004068EA                 mov     ebp, [esi+18h]</span><br><span class="line">.text:004068ED                 push    1</span><br><span class="line">.text:004068EF                 sub     esp, 48h</span><br><span class="line">.text:004068F2                 sub     ebp, 29Ch</span><br><span class="line">.text:004068F8                 mov     byte ptr [esi+140h], 1</span><br><span class="line">.text:004068FF                 cmp     ebp, esp</span><br><span class="line">.text:00406901                 jnz     loc_40686C</span><br><span class="line">.text:00406907                 and     dword ptr [ebp+2Ch], 0</span><br><span class="line">.text:0040690B                 test    byte ptr [esi+2Ch], 0FFh</span><br><span class="line">.text:0040690F                 mov     [esi+134h], ebp</span><br><span class="line">.text:00406915                 jnz     Dr_FastCallDrSave</span><br><span class="line">.text:0040691B</span><br><span class="line">.text:0040691B loc_40691B:                             ; CODE XREF: Dr_FastCallDrSave+10↑j</span><br><span class="line">.text:0040691B                                         ; Dr_FastCallDrSave+7C↑j</span><br><span class="line">.text:0040691B                 mov     ebx, [ebp+60h]</span><br><span class="line">.text:0040691E                 mov     edi, [ebp+68h]</span><br><span class="line">.text:00406921                 mov     [ebp+0Ch], edx</span><br><span class="line">.text:00406924                 mov     dword ptr [ebp+8], 0BADB0D00h</span><br><span class="line">.text:0040692B                 mov     [ebp+0], ebx</span><br><span class="line">.text:0040692E                 mov     [ebp+4], edi</span><br><span class="line">.text:00406931                 sti</span><br><span class="line">.text:00406932</span><br><span class="line">.text:00406932 loc_406932:                             ; CODE XREF: _KiBBTUnexpectedRange+18↑j</span><br><span class="line">.text:00406932                                         ; _KiSystemService+71↑j</span><br><span class="line">.text:00406932                 mov     edi, eax        ; 取出3环传进来的系统调用号</span><br><span class="line">.text:00406934                 shr     edi, 8          ; 右移8位</span><br><span class="line">.text:00406937                 and     edi, 30h        ; 检测系统调用号12位</span><br><span class="line">.text:00406937                                         ; 如果等于1，那么 edi == 0x10</span><br><span class="line">.text:00406937                                         ; 如果等于0，那么 edi == 0x00</span><br><span class="line">.text:0040693A                 mov     ecx, edi</span><br><span class="line">.text:0040693C                 add     edi, [esi+0E0h] ; edi += CurrentThread.ServiceTable</span><br><span class="line">.text:0040693C                                         ; 此时 edi 指向了API对应的系统服务表</span><br><span class="line">.text:0040693C                                         ;</span><br><span class="line">.text:0040693C                                         ; 0x10 刚好是系统服务表的大小</span><br><span class="line">.text:0040693C                                         ; 系统服务表有 ServiceTable, Count, ServiceLimit 和 ArgmentTable</span><br><span class="line">.text:0040693C                                         ;  4项共0x10字节，所以通过这里的代码也可以推断，内核和win32k.sys的系统服务表是连续的</span><br><span class="line">.text:0040693C                                         ;  第一张是内核的，第二张是win32k.sys的</span><br><span class="line">.text:00406942                 mov     ebx, eax        ; ebx = 系统调用号</span><br><span class="line">.text:00406944                 and     eax, 0FFFh      ; eax = 系统服务表下标</span><br><span class="line">.text:00406949                 cmp     eax, [edi+8]</span><br><span class="line">.text:0040694C                 jnb     _KiBBTUnexpectedRange ; 检查系统调用号是否超过系统服务表的范围，超过就跳到异常处理</span><br><span class="line">.text:00406952                 cmp     ecx, 10h</span><br><span class="line">.text:00406955                 jnz     short loc_406972 ; 跳转条件：系统服务（ntdll.dll 的API）</span><br><span class="line">.text:00406955                                         ; 不跳转条件：图形及用户界面（gdi.dll 的API）</span><br><span class="line">.text:00406957                 mov     ecx, large fs:18h</span><br><span class="line">.text:0040695E                 xor     ebx, ebx</span><br><span class="line">.text:0040695E _KiFastCallEntry endp ; sp-analysis failed</span><br><span class="line">.text:0040695E</span><br><span class="line">.text:00406960</span><br><span class="line">.text:00406960 ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:00406960</span><br><span class="line">.text:00406960</span><br><span class="line">.text:00406960 ; _DWORD __stdcall KiSystemServiceAccessTeb()</span><br><span class="line">.text:00406960 _KiSystemServiceAccessTeb@0 proc near   ; DATA XREF: KiPreprocessAccessViolation(x,x,x)+3D↓o</span><br><span class="line">.text:00406960</span><br><span class="line">.text:00406960 ; FUNCTION CHUNK AT .text:00406B4F SIZE 0000000A BYTES</span><br><span class="line">.text:00406960</span><br><span class="line">.text:00406960                 or      ebx, [ecx+0F70h]</span><br><span class="line">.text:00406966                 jz      short loc_406972 ; _KCPR.KPRCB.KeSystemCalls += 1, 系统调用计数加1</span><br><span class="line">.text:00406968                 push    edx</span><br><span class="line">.text:00406969                 push    eax</span><br><span class="line">.text:0040696A                 call    ds:_KeGdiFlushUserBatch</span><br><span class="line">.text:00406970                 pop     eax</span><br><span class="line">.text:00406971                 pop     edx</span><br><span class="line">.text:00406972</span><br><span class="line">.text:00406972 loc_406972:                             ; CODE XREF: _KiFastCallEntry+B6↑j</span><br><span class="line">.text:00406972                                         ; KiSystemServiceAccessTeb()+6↑j</span><br><span class="line">.text:00406972                 inc     large dword ptr fs:638h ; _KCPR.KPRCB.KeSystemCalls += 1, 系统调用计数加1</span><br><span class="line">.text:00406979                 mov     esi, edx        ; esi = edx = 3环参数指针</span><br><span class="line">.text:0040697B                 mov     ebx, [edi+0Ch]  ; ebx 指向函数参数表</span><br><span class="line">.text:0040697B                                         ; eax 是系统调用号</span><br><span class="line">.text:0040697E                 xor     ecx, ecx</span><br><span class="line">.text:00406980                 mov     cl, [eax+ebx]   ; cl = 参数字节数</span><br><span class="line">.text:00406983                 mov     edi, [edi]      ; edi 指向函数地址表</span><br><span class="line">.text:00406985                 mov     ebx, [edi+eax*4] ; ebx 指向0环函数</span><br><span class="line">.text:00406988                 sub     esp, ecx        ; 从这句开始，到call为止，完成了复制3环参数的工作</span><br><span class="line">.text:00406988                                         ; 这句是模拟压栈操作</span><br><span class="line">.text:0040698A                 shr     ecx, 2          ; 参数字节数 / 4，得到参数个数</span><br><span class="line">.text:0040698D                 mov     edi, esp</span><br><span class="line">.text:0040698F                 test    byte ptr [ebp+72h], 2</span><br><span class="line">.text:00406993                 jnz     short loc_40699B ; 越界检查</span><br><span class="line">.text:00406993                                         ; 如果 esi（3环参数指针）大于等于 0x7fff0000，则返回 c0000005 异常</span><br><span class="line">.text:00406995                 test    byte ptr [ebp+6Ch], 1</span><br><span class="line">.text:00406999                 jz      short _KiSystemServiceCopyArguments@0 ; 复制参数：复制 esi 到 edi，每次复制4字节，次数由 ecx 决定</span><br><span class="line">.text:00406999                                         ; 方向由DF决定，DF=0，故每次复制后，edi 和 esi 都加4</span><br><span class="line">.text:0040699B</span><br><span class="line">.text:0040699B loc_40699B:                             ; CODE XREF: KiSystemServiceAccessTeb()+33↑j</span><br><span class="line">.text:0040699B                 cmp     esi, ds:_MmUserProbeAddress ; 越界检查</span><br><span class="line">.text:0040699B                                         ; 如果 esi（3环参数指针）大于等于 0x7fff0000，则返回 c0000005 异常</span><br><span class="line">.text:004069A1                 jnb     loc_406B4F</span><br><span class="line">.text:004069A1 _KiSystemServiceAccessTeb@0 endp</span><br><span class="line">.text:004069A1</span><br><span class="line">.text:004069A7</span><br><span class="line">.text:004069A7 ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:004069A7</span><br><span class="line">.text:004069A7 ; 复制参数：复制 esi 到 edi，每次复制4字节，次数由 ecx 决定</span><br><span class="line">.text:004069A7 ; 方向由DF决定，DF=0，故每次复制后，edi 和 esi 都加4</span><br><span class="line">.text:004069A7</span><br><span class="line">.text:004069A7 ; _DWORD __stdcall KiSystemServiceCopyArguments()</span><br><span class="line">.text:004069A7 _KiSystemServiceCopyArguments@0 proc near</span><br><span class="line">.text:004069A7                                         ; CODE XREF: KiSystemServiceAccessTeb()+39↑j</span><br><span class="line">.text:004069A7                                         ; DATA XREF: KiPreprocessAccessViolation(x,x,x):loc_4628DF↓o</span><br><span class="line">.text:004069A7                 rep movsd</span><br><span class="line">.text:004069A9                 call    ebx             ; 复制参数：复制 esi 到 edi，每次复制4字节，次数由 ecx 决定</span><br><span class="line">.text:004069A9 _KiSystemServiceCopyArguments@0 endp    ; 方向由DF决定，DF=0，故每次复制后，edi 和 esi 都加4</span><br><span class="line">.text:004069A9                                         ; 调用内核函数</span><br><span class="line">.text:004069AB</span><br></pre></td></tr></table></figure>





<h1 id="006-API函数的调用过程-SSDT"><a href="#006-API函数的调用过程-SSDT" class="headerlink" title="006.API函数的调用过程(SSDT)"></a>006.API函数的调用过程(SSDT)</h1><p>本节通过其他方式来访问系统服务表.</p>
<p>SSDT  的全称是 System Services Descriptor Table，系统服务描述符表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd  KeServiceDescriptorTable(SSDT)</span><br><span class="line">导出的 声明一下就可以使用了</span><br><span class="line"></span><br><span class="line">kd&gt; dd  KeServiceDescriptorTableShadow(SSDT Shadow)</span><br><span class="line">未导出 需要用其他的方式来查找</span><br></pre></td></tr></table></figure>

<p>上面的是导出的，下面是未导出的，可以看到导出的里面只有一张表有值，其余三张没有值，如果想看第二张表的话可以看未导出的：</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230107234334197.png" alt="image-20230107234334197"></p>
<p>这里使用前面的那个函数进入0环需要的系统服务号(BA)，这里要*4，每个是4字节（其实下面的那个函数就是<code>nt!NtReadVirtualMemory</code>这个函数）：</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230107235014722.png" alt="image-20230107235014722"></p>
<p>所需要的参数的字节数，0x14，也就是20字节：</p>
<p><img src="/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/image-20230107235309282.png" alt="image-20230107235309282"></p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2022/10/23/DIR815/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2023-01-16 00:00:00
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="Categories"></i>
                    
                    <span class="span--category">
                      <a href="/categories/Technology/" title="Technology">
                        <b>#</b> Technology
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Win32/" title="Win32">
                        #Win32
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2023/01/18/2023-1-WinKernel%E9%A9%B1%E5%8A%A8/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#001-API%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B-3%E7%8E%AF%E9%83%A8%E5%88%86"><span class="toc-text">001.API函数的调用过程(3环部分)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#002-API%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B-3%E7%8E%AF%E8%BF%9B0%E7%8E%AF-%E4%B8%8A"><span class="toc-text">002.API函数的调用过程(3环进0环 上)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#KUSER-SHARED-DATA"><span class="toc-text">_KUSER_SHARED_DATA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CPU%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81%E5%BF%AB%E9%80%9F%E8%B0%83%E7%94%A8"><span class="toc-text">CPU是否支持快速调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9BR0%E9%9C%80%E8%A6%81%E6%9B%B4%E6%94%B9%E5%93%AA%E4%BA%9B%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-text">进R0需要更改哪些寄存器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#003-API%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B-3%E7%8E%AF%E8%BF%9B0%E7%8E%AF-%E4%B8%8B"><span class="toc-text">003.API函数的调用过程(3环进0环 下)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#004-API%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B-%E4%BF%9D%E5%AD%98%E7%8E%B0%E5%9C%BA"><span class="toc-text">004.API函数的调用过程(保存现场)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Trap-Frame%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">_Trap_Frame结构体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ETHREAD%E7%BA%BF%E7%A8%8B%E7%9B%B8%E5%85%B3%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">_ETHREAD线程相关的结构体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KPCR"><span class="toc-text">_KPCR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-KiSystemService"><span class="toc-text">逆向分析 KiSystemService</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#005-API%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E8%A1%A8"><span class="toc-text">005.API函数的调用过程(系统服务表)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#006-API%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B-SSDT"><span class="toc-text">006.API函数的调用过程(SSDT)</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/Ghostasky">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/ghostasky">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/Ghostasky">怕什么真理无穷，进一寸有进一寸的欢喜。</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2024 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + Windows%E5%86%85%E6%A0%B8(%E4%B8%89)%E2%80%94%E2%80%94%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8 + '&url=' + https%3A%2F%2Fghostasky.github.io%2F2023%2F01%2F16%2F2023-1-WinKernel%25E7%25B3%25BB%25E7%25BB%259F%25E8%25B0%2583%25E7%2594%25A8%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://ghostasky.github.io/2023/01/16/2023-1-WinKernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
